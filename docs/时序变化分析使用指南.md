# 时序变化分析使用指南

## 📖 功能简介

时序变化分析功能用于分析不同时间段内农作物种植情况的变化，帮助你：

- 🔍 追踪每个地块在多个时期的作物种植情况
- 📊 统计作物变化频率和变化模式
- 🔄 识别作物轮作模式
- 📈 可视化作物转换流向
- 📉 分析作物种植结构变化趋势

## 🚀 快速开始

### 第一步：准备数据

确保你有至少 **2个不同时间段** 的作物识别结果（GeoJSON格式）。

**数据要求：**
- 格式：GeoJSON
- 必需字段：`Id`（地块标识）、`gridcode`（作物代码）
- 可选字段：`area`（面积）、`plotName`（地块名称）

### 第二步：执行分析

1. 进入 **任务管理** 页面
2. 找到 **"变化检测与差异分析"** 模块
3. 点击 **"时序变化分析"** 卡片
4. 在弹出的对话框中，选择至少2个识别结果文件
5. 点击 **"开始分析"**

### 第三步：查看结果

分析完成后，系统会自动跳转到 **"结果查看与比对"** 页面，选择 **"时序分析"** 标签即可查看分析结果。

## 📊 功能详解

### 1. 时间轴视图

**功能：** 以时间轴形式展示地块在不同时期的作物变化

**特点：**
- 🎯 直观的地块网格展示
- ⏰ 可拖动的时间轴滑块
- 🔍 鼠标悬停查看详细信息
- 📝 变化地块列表

**操作：**
- 使用滑块或按钮切换时间点
- 点击时间标签快速跳转
- 悬停在地块上查看详细轨迹

### 2. 统计分析视图

**功能：** 以表格形式展示详细的统计数据

**包含信息：**
- 地块名称
- 变化次数
- 起始作物
- 结束作物
- 完整的时序轨迹

**操作：**
- 排序：点击表头进行排序
- 筛选：使用搜索框快速定位
- 导出：可导出为Excel或CSV

### 3. 图表视图

#### 3.1 作物分布趋势图

**功能：** 展示每个时间点的作物分布情况

**支持模式：**
- 📊 **数量模式**：按地块数量统计
- 📏 **面积模式**：按种植面积统计
- 📈 **占比模式**：按百分比展示

**特点：**
- 时间点选择器
- 进度条可视化
- 各时期对比表格

#### 3.2 作物转换流向图

**功能：** 展示作物之间的转换关系

**显示内容：**
- 转换路径：从哪种作物变为哪种作物
- 转换数量：有多少地块发生了这种转换
- 流向宽度：直观显示转换规模

**应用场景：**
- 识别主要的作物转换类型
- 分析作物替代关系
- 优化种植结构规划

#### 3.3 轮作模式分析图

**功能：** 识别和统计作物轮作模式

**显示内容：**
- 轮作序列：完整的作物种植顺序
- 频率统计：每种模式出现的次数
- TOP排名：最常见的轮作模式

**应用场景：**
- 发现常见轮作模式
- 评估轮作合理性
- 指导未来种植规划

## 🎯 使用场景

### 场景1：监测土地违规使用

**需求：** 监测农田是否按规划种植

**操作流程：**
1. 选择规划时间点和多个实际监测时间点
2. 执行时序分析
3. 查看变化地块列表，重点关注变化次数多的地块
4. 在作物转换流向图中识别异常转换

### 场景2：分析作物轮作效果

**需求：** 评估农田轮作情况

**操作流程：**
1. 选择连续多个季节的识别结果
2. 执行时序分析
3. 切换到图表视图
4. 查看轮作模式分析，评估轮作多样性

### 场景3：追踪地块历史变化

**需求：** 了解某个地块的历史种植情况

**操作流程：**
1. 选择所有历史时期的数据
2. 执行时序分析
3. 在统计分析视图中搜索目标地块
4. 查看完整的时序轨迹

## 📁 数据导出

### CSV导出

**路径：** 时间轴视图 → 导出CSV

**包含内容：**
```csv
地块ID,地块名称,变化次数,2024-01-01,2024-04-01,2024-07-01
1,地块A,2,水稻,小麦,玉米
2,地块B,0,小麦,小麦,小麦
...
```

### Excel报告

**路径：** 分析完成后自动生成

**包含内容：**
- 📊 统计汇总表
- 📈 变化趋势图
- 📋 详细数据表
- 🔄 作物转换矩阵

## ⚙️ 高级配置

### 1. 地块匹配策略

系统使用以下策略匹配不同时间点的地块：

1. **ID匹配**（优先）：基于 `Id` 字段精确匹配
2. **几何匹配**（备选）：基于地块中心点位置匹配

**配置位置：** `src/utils/temporalAnalysis.js` → `matchFeatures` 函数

```javascript
const matches = matchFeatures(baseFeatures, targetFeatures, {
  useId: true,              // 是否使用ID匹配
  idField: 'Id',            // ID字段名
  distanceThreshold: 10     // 几何匹配的距离阈值（米）
})
```

### 2. 作物类型配置

详见 [作物类型配置说明](./作物类型配置说明.md)

### 3. 显示数量限制

出于性能考虑，地图视图默认只显示前50个地块。

**修改方法：** 在 `TemporalMapViewEnhanced.vue` 中修改：

```javascript
const displayFeatures = computed(() => {
  return props.data.features.slice(0, 50) // 修改这个数字
})
```

## 🔍 算法说明

### 地块匹配算法

**目标：** 在不同时间点识别同一个地块

**步骤：**
1. 优先使用 `Id` 字段进行精确匹配
2. 如果ID匹配失败，计算地块中心点距离
3. 如果距离小于阈值，认为是同一地块
4. 匹配度 > 50% 才保留匹配结果

### 变化检测算法

**目标：** 识别地块的作物变化

**步骤：**
1. 构建每个地块的时序轨迹
2. 比较相邻时间点的作物类型
3. 统计变化次数和变化时刻
4. 生成变化统计报告

### 轮作模式识别

**目标：** 识别常见的作物轮作模式

**步骤：**
1. 提取每个地块的作物序列
2. 将序列转换为字符串模式
3. 统计每种模式的出现频率
4. 按频率排序，返回TOP 10

## 📈 性能优化

### 大数据量处理

如果你的数据量很大（超过1000个地块或10个时间点），建议：

1. **分批处理**：将数据分为多个区域分别分析
2. **简化可视化**：减少地图视图中的显示数量
3. **使用筛选**：只分析有变化的地块

### 浏览器性能

- 建议使用 Chrome 或 Edge 浏览器
- 关闭不必要的浏览器标签页
- 确保有足够的内存（建议8GB以上）

## ❓ 常见问题

### Q1: 分析结果为空？

**可能原因：**
- 不同时间点的地块ID不一致
- GeoJSON文件损坏或格式错误
- 必需字段缺失

**解决方法：**
1. 检查GeoJSON文件的 `Id` 字段
2. 确保所有文件格式正确
3. 查看浏览器控制台的错误信息

### Q2: 地块无法匹配？

**可能原因：**
- ID字段名称不一致
- ID值在不同时间点发生了变化
- 几何位置偏移过大

**解决方法：**
1. 统一ID字段名称
2. 确保相同地块使用相同ID
3. 调整几何匹配的距离阈值

### Q3: 作物类型显示为"作物1"？

**原因：** `gridcode` 值在映射表中没有对应项

**解决方法：** 参考 [作物类型配置说明](./作物类型配置说明.md) 添加映射

### Q4: 分析很慢？

**优化建议：**
1. 减少分析的时间点数量
2. 减少地块数量（可以按区域筛选）
3. 使用更高性能的电脑

## 🎓 最佳实践

### 1. 数据准备

- ✅ 确保数据质量，避免缺失值
- ✅ 使用统一的坐标系统
- ✅ 保持ID编码的一致性
- ✅ 定期备份原始数据

### 2. 分析策略

- ✅ 先做小范围测试，再全量分析
- ✅ 按季节或年份分组分析
- ✅ 关注变化频繁的地块
- ✅ 结合实地调查验证结果

### 3. 结果应用

- ✅ 导出完整报告供决策参考
- ✅ 定期更新分析结果
- ✅ 与相关部门共享发现
- ✅ 建立长期监测机制

## 📚 相关文档

- [作物类型配置说明](./作物类型配置说明.md)
- [快速开始](./快速开始.md)
- [功能使用指南](./功能使用指南.md)
- [TIF优化完整指南](./TIF优化完整指南.md)

## 🆘 技术支持

如遇到问题，请：
1. 查看浏览器控制台的错误信息
2. 检查数据格式是否正确
3. 参考本文档的常见问题部分
4. 联系技术支持团队

---

**版本：** 1.0.0  
**最后更新：** 2025-01-20



