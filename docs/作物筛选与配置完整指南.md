# 作物筛选与配置完整指南

> **文档版本：** v2.0  
> **最后更新：** 2025-10-21  
> **功能状态：** ✅ 已完成

---

## 📑 目录

- [功能概述](#功能概述)
- [作物类型配置](#作物类型配置)
- [作物转换关系筛选](#作物转换关系筛选)
- [筛选联动功能](#筛选联动功能)
- [使用示例](#使用示例)
- [技术实现](#技术实现)

---

## 功能概述

### 什么是作物筛选功能？

作物筛选功能用于在差异检测和时序分析中，根据作物类型的转换关系筛选和查看数据。主要应用场景：

1. **差异检测** - 查看某种作物转换为其他作物的情况
2. **时序分析** - 追踪特定作物在多个时期的变化
3. **统计分析** - 按作物类型统计面积和地块数量

---

## 作物类型配置

### 配置位置

作物类型在前端代码中配置：

**文件路径：** `src/views/ResultCompare/components/DifferenceMapViewOptimized.vue`

### 配置格式

```javascript
const cropTypes = [
  { value: '', label: '全部作物', color: '#409EFF' },
  { value: 'corn', label: '玉米', color: '#67C23A' },
  { value: 'wheat', label: '小麦', color: '#E6A23C' },
  { value: 'rice', label: '水稻', color: '#F56C6C' },
  { value: 'soybean', label: '大豆', color: '#909399' },
  { value: 'cotton', label: '棉花', color: '#FFFFFF' },
  { value: 'vegetables', label: '蔬菜', color: '#95DE64' },
  { value: 'fallow', label: '休耕', color: '#D3ADF7' },
  { value: 'other', label: '其他', color: '#BFBFBF' }
]
```

### 配置说明

| 字段 | 说明 | 示例 | 必填 |
|------|------|------|------|
| `value` | 作物类型唯一标识 | `'corn'` | ✅ |
| `label` | 显示名称 | `'玉米'` | ✅ |
| `color` | 地图和图表中的颜色 | `'#67C23A'` | ✅ |

### 添加新作物类型

```javascript
// 在cropTypes数组中添加
{
  value: 'potato',      // 作物标识（英文）
  label: '马铃薯',      // 显示名称（中文）
  color: '#FFB800'      // 颜色（十六进制）
}
```

**注意事项：**
- `value` 必须与后端识别结果中的作物字段值一致
- `color` 建议使用不同的颜色以便区分
- 修改后需要重启前端服务

---

## 作物转换关系筛选

### 功能说明

在差异检测结果中，可以根据作物转换关系筛选地块：

- **原始作物筛选** - 2023年种植的作物类型
- **对比作物筛选** - 2024年种植的作物类型
- **转换关系** - 原始作物 → 对比作物

### 筛选条件

#### 1. 原始作物筛选

```vue
<el-select v-model="filters.baseCrop" placeholder="原始图作物类型" clearable>
  <el-option label="全部作物" value="" />
  <el-option label="玉米" value="corn" />
  <el-option label="小麦" value="wheat" />
  <!-- 更多作物... -->
</el-select>
```

**说明：**
- 选择"玉米"：只显示2023年种植玉米的地块
- 选择"全部作物"：显示所有地块

#### 2. 对比作物筛选

```vue
<el-select v-model="filters.compareCrop" placeholder="对比图作物类型" clearable>
  <el-option label="全部作物" value="" />
  <el-option label="玉米" value="corn" />
  <el-option label="小麦" value="wheat" />
  <!-- 更多作物... -->
</el-select>
```

**说明：**
- 选择"小麦"：只显示2024年种植小麦的地块
- 结合原始作物筛选，可查看特定转换（如玉米→小麦）

---

## 筛选联动功能

### v2.0 新增特性（2025-10-21）

#### 功能说明

筛选条件之间会自动联动，确保筛选选项始终有效：

1. **原始作物筛选联动**
   - 选择对比作物后，原始作物选项只显示实际存在的转换关系
   - 例如：选择对比作物为"小麦"，原始作物只显示实际转换为小麦的作物类型

2. **对比作物筛选联动**
   - 选择原始作物后，对比作物选项只显示实际转换到的作物类型
   - 例如：选择原始作物为"玉米"，对比作物只显示玉米实际转换到的作物类型

#### 实现逻辑

```javascript
// 可用的原始作物选项（根据对比作物动态计算）
const availableBaseCrops = computed(() => {
  if (!filters.value.compareCrop) {
    // 未选择对比作物时，显示所有出现过的原始作物
    return allCropTypes.filter(crop => 
      baseFeatures.some(f => f.properties.crop === crop.value)
    )
  }
  
  // 选择对比作物后，只显示实际转换到该对比作物的原始作物
  const validBaseCrops = new Set()
  featureCollection.features.forEach(f => {
    if (f.properties.compareCrop === filters.value.compareCrop) {
      validBaseCrops.add(f.properties.baseCrop)
    }
  })
  
  return allCropTypes.filter(crop => validBaseCrops.has(crop.value))
})

// 可用的对比作物选项（根据原始作物动态计算）
const availableCompareCrops = computed(() => {
  if (!filters.value.baseCrop) {
    // 未选择原始作物时，显示所有出现过的对比作物
    return allCropTypes.filter(crop =>
      compareFeatures.some(f => f.properties.crop === crop.value)
    )
  }
  
  // 选择原始作物后，只显示该原始作物实际转换到的对比作物
  const validCompareCrops = new Set()
  featureCollection.features.forEach(f => {
    if (f.properties.baseCrop === filters.value.baseCrop) {
      validCompareCrops.add(f.properties.compareCrop)
    }
  })
  
  return allCropTypes.filter(crop => validCompareCrops.has(crop.value))
})
```

#### 用户体验改进

**优化前：**
- 可以选择不存在的转换关系
- 选择后显示"无数据"
- 用户困惑

**优化后：**
- 只显示实际存在的转换关系
- 避免无效选择
- 提升用户体验

---

## 使用示例

### 示例1：查看玉米转小麦的地块

**步骤：**

1. 打开差异检测结果页面
2. 在筛选条件中：
   - 原始作物：选择"玉米"
   - 对比作物：选择"小麦"
3. 点击"应用筛选"

**结果：**
- 地图上只显示原本种植玉米，现在改种小麦的地块
- 统计信息更新为筛选后的数据

---

### 示例2：查看所有转为休耕的地块

**步骤：**

1. 打开差异检测结果页面
2. 在筛选条件中：
   - 原始作物：选择"全部作物"
   - 对比作物：选择"休耕"
3. 点击"应用筛选"

**结果：**
- 地图上显示所有改为休耕的地块
- 无论之前种植什么作物

---

### 示例3：查看玉米地块的所有转换

**步骤：**

1. 打开差异检测结果页面
2. 在筛选条件中：
   - 原始作物：选择"玉米"
   - 对比作物：观察下拉选项

**结果：**
- 对比作物下拉框只显示玉米实际转换到的作物类型
- 例如：小麦、大豆、休耕（排除了不存在的转换，如玉米→水稻）

---

## 技术实现

### 前端架构

#### 1. 数据结构

```javascript
// GeoJSON Feature 结构
{
  type: "Feature",
  geometry: { type: "Polygon", coordinates: [...] },
  properties: {
    baseCrop: "corn",      // 原始作物
    compareCrop: "wheat",   // 对比作物
    area: 1200,            // 面积（平方米）
    changed: true          // 是否发生变化
  }
}
```

#### 2. 筛选逻辑

```javascript
// 筛选Features
const filteredFeatures = computed(() => {
  let features = [...featureCollection.features]
  
  // 按原始作物筛选
  if (filters.value.baseCrop) {
    features = features.filter(f => 
      f.properties.baseCrop === filters.value.baseCrop
    )
  }
  
  // 按对比作物筛选
  if (filters.value.compareCrop) {
    features = features.filter(f => 
      f.properties.compareCrop === filters.value.compareCrop
    )
  }
  
  return features
})
```

#### 3. 统计计算

```javascript
// 统计信息
const statistics = computed(() => {
  const stats = {
    totalArea: 0,
    totalPlots: filteredFeatures.value.length,
    changedPlots: 0,
    unchangedPlots: 0
  }
  
  filteredFeatures.value.forEach(f => {
    stats.totalArea += f.properties.area
    if (f.properties.changed) {
      stats.changedPlots++
    } else {
      stats.unchangedPlots++
    }
  })
  
  return stats
})
```

---

### 后端数据格式

#### GeoJSON文件示例

```json
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "geometry": {
        "type": "Polygon",
        "coordinates": [[[lng1, lat1], [lng2, lat2], ...]]
      },
      "properties": {
        "id": "plot_001",
        "baseCrop": "corn",
        "compareCrop": "wheat",
        "baseYear": 2023,
        "compareYear": 2024,
        "area": 1200,
        "changed": true
      }
    }
  ]
}
```

---

## 更新日志

### v2.0 (2025-10-21)

#### ✨ 新增功能
- ✅ 作物筛选联动功能
- ✅ 动态计算可用的作物选项
- ✅ 避免无效的筛选组合

#### 🎨 UI改进
- ✅ 优化筛选下拉框选项
- ✅ 改善用户交互体验

---

### v1.0 (2025-10-20)

#### ✨ 初始版本
- 基础作物类型配置
- 原始/对比作物筛选
- 作物转换统计

---

## 📚 相关文档

- [功能使用指南](./功能使用指南.md) - 前端功能详细说明
- [时序分析功能完整指南](./时序分析功能完整指南.md) - 时序分析功能
- [差异检测结果查看指南](./差异检测结果查看指南.md) - 差异检测功能

---

> **文档维护者：** AI Assistant  
> **最后更新：** 2025-10-21  
> **文档版本：** v2.0


