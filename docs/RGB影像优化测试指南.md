# RGB影像优化测试指南

## 📋 问题修复总结

### 修复的问题
1. ❌ **色彩失真** - 紫绿色调 → ✅ 真实色彩
2. ❌ **黑色背景** - 背景黑色 → ✅ 正常背景

### 修复方案
- 移除独立波段拉伸（`-scale_1/-scale_2/-scale_3`）
- 智能判断数据类型（反射率 vs DN值）
- 移除NoData设置（`-a_nodata 0`）

## 🧪 测试步骤

### 第1步：删除旧的优化文件

```powershell
# 在项目根目录执行
cd public/data/data_tif
rm *RGB_optimized.tif
```

或者手动删除 `public/data/data_tif/` 目录下所有 `*RGB_optimized.tif` 文件

### 第2步：重启后端服务

```powershell
# 停止当前服务（按 Ctrl+C）
# 然后重新启动
cd server
node app.js
```

### 第3步：重新优化RGB影像

1. 打开浏览器访问 http://localhost:3000
2. 进入 **影像管理** 页面
3. 找到RGB影像（例如：`KEC20250611RGB.tif`）
4. 点击该影像的 **优化** 按钮
5. 等待优化完成（查看进度条）

### 第4步：验证缩略图

#### 4.1 查看优化前的影像
1. 找到原始文件 `KEC20250611RGB.tif`
2. 点击 **预览** 按钮
3. **观察色彩**：应该是自然真实的地形色彩

#### 4.2 查看优化后的影像
1. 找到优化后的文件 `KEC20250611RGB_optimized.tif`
2. 点击 **预览** 按钮
3. **对比检查**：
   - ✅ 色彩应该与原图基本一致
   - ✅ 背景应该正常（不是黑色）
   - ✅ 地物特征清晰可见
   - ✅ 没有紫绿色调

### 第5步：在主控台验证地图显示

1. 进入 **主控台** 页面
2. 选择筛选条件：
   - 年份：2025年
   - 期次：第4期
   - 影像名称：`KEC20250611RGB_optimized.tif`（优化后）
3. 点击 **查询** 按钮
4. 打开图例开关（勾选"作物分类"）
5. **验证地图显示**：
   - ✅ 色彩真实自然
   - ✅ 可以看清地形地貌
   - ✅ 没有异常色调
   - ✅ 背景正常

## ✅ 预期效果

### 优化前的问题
```
原图（正常）→ 优化后（❌紫绿色 + ❌黑背景）
```

### 修复后的效果
```
原图（正常）→ 优化后（✅正常色彩 + ✅正常背景）
```

## 📊 检查要点

### 色彩检查
- [ ] 天空/水体：应该是蓝色或灰色
- [ ] 植被：应该是绿色或棕色
- [ ] 裸地：应该是棕色或灰白色
- [ ] 建筑：应该是灰色或白色
- [ ] **无紫色或荧光绿色调**

### 背景检查
- [ ] 影像边缘外的区域不是黑色
- [ ] 无数据区域显示正常
- [ ] 地图其他区域（如底图）可见

### 文件检查
- [ ] 优化后文件大小：0.7-1.0MB（压缩率96%+）
- [ ] 文件格式：COG（云优化GeoTIFF）
- [ ] 坐标系：EPSG:3857
- [ ] 压缩方式：JPEG

## 🔍 常见问题排查

### Q1: 优化后仍然有色彩问题？

**检查步骤：**
1. 确认后端服务已重启（修改代码后必须重启）
2. 确认删除了旧的优化文件
3. 检查控制台日志，查看优化命令是否正确：
   ```
   ✅ 策略：智能转换（保持RGB原始色彩）
   ✅ 不设置NoData值（避免背景问题）
   ```

### Q2: 背景仍然是黑色？

**可能原因：**
1. 使用了旧的优化文件 → 删除后重新优化
2. 前端缓存问题 → 清除浏览器缓存（Ctrl+Shift+Delete）
3. 底图没有加载 → 检查网络连接

### Q3: 优化失败或卡住？

**解决方法：**
1. 检查GDAL是否正确安装：
   ```bash
   gdalinfo --version
   ```
2. 检查文件权限：确保后端有读写权限
3. 查看后端控制台的错误信息
4. 检查磁盘空间是否充足

### Q4: 如何判断是反射率还是DN值？

查看后端控制台日志：

```
Band 1 (红): 0.0234 ~ 0.8765  ← 反射率（0-1）
Band 2 (绿): 0.0156 ~ 0.7654
Band 3 (蓝): 0.0189 ~ 0.8234

📊 检测到反射率数据（0-1范围），需要缩放到0-255
```

或者

```
Band 1 (红): 15.0000 ~ 245.0000  ← DN值（0-255）
Band 2 (绿): 10.0000 ~ 250.0000
Band 3 (蓝): 12.0000 ~ 248.0000

📊 检测到DN值数据（250范围），直接转换
```

## 📝 测试记录模板

```
测试日期：2025-10-29
测试人员：[你的名字]
测试文件：KEC20250611RGB.tif

【修复前】
- 色彩：❌ 紫绿色调
- 背景：❌ 黑色
- 地物识别：❌ 困难

【修复后】
- 色彩：✅ / ❌
- 背景：✅ / ❌
- 地物识别：✅ / ❌
- 文件大小：____MB
- 优化耗时：____秒

【备注】
[记录任何问题或建议]
```

## 🚀 后续优化建议

1. **批量重新优化**
   - 一次性优化所有RGB影像
   - 提供批量优化按钮

2. **添加对比预览**
   - 并排显示优化前后
   - 方便快速对比

3. **自动检测异常**
   - 检测色彩失真
   - 自动重新优化

---

**文档版本**: v2.0  
**更新时间**: 2025-10-29  
**适用范围**: RGB真彩色影像优化

