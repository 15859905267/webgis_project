# SHP文件处理完整指南

## 📅 最后更新
2025年10月20日

---

## 目录

1. [SHP文件基础](#shp文件基础)
2. [识别和上传](#识别和上传)
3. [常见问题](#常见问题)
4. [快速诊断](#快速诊断)
5. [故障排查](#故障排查)
6. [后端配置](#后端配置)

---

## SHP文件基础

### 什么是SHP文件？

SHP（Shapefile）是一种常见的地理空间矢量数据格式，通常包含以下文件：

- **必需文件**：
  - `.shp` - 存储几何形状
  - `.shx` - 索引文件
  - `.dbf` - 属性数据

- **可选文件**：
  - `.prj` - 投影信息
  - `.cpg` - 编码信息
  - `.sbn/.sbx` - 空间索引
  - `.shp.xml` - 元数据

### 文件要求

1. **完整性**：必须包含 `.shp`, `.shx`, `.dbf` 三个核心文件
2. **命名**：所有文件的主文件名必须相同
3. **编码**：建议使用UTF-8编码
4. **坐标系**：建议包含 `.prj` 文件说明坐标系

---

## 识别和上传

### 上传流程

1. **选择文件**：
   - 点击"上传SHP文件"按钮
   - 选择完整的SHP文件组
   - 支持拖拽上传

2. **文件验证**：
   - 系统自动检查文件完整性
   - 验证文件格式
   - 检查坐标系统

3. **识别处理**：
   - 解析几何数据
   - 提取属性信息
   - 进行作物识别

4. **结果查看**：
   - 在地图上显示识别结果
   - 查看属性表
   - 导出分析报告

### UI优化

- ✅ 友好的上传界面
- ✅ 实时进度提示
- ✅ 错误信息明确
- ✅ 支持批量上传

---

## 常见问题

### 问题1：文件上传失败

**症状**：
- 上传后显示"文件格式错误"
- 或显示"文件不完整"

**原因**：
1. 缺少必需的文件（.shp, .shx, .dbf）
2. 文件损坏
3. 文件命名不一致

**解决方案**：
```
✅ 检查清单：
1. [ ] .shp 文件存在
2. [ ] .shx 文件存在
3. [ ] .dbf 文件存在
4. [ ] 所有文件主文件名相同
5. [ ] 文件未损坏（可以用QGIS打开）
```

---

### 问题2：识别结果为空

**症状**：
- 文件上传成功
- 但地图上没有显示任何内容

**原因**：
1. 坐标系不匹配
2. 几何数据为空
3. 属性字段缺失

**解决方案**：

1. **检查坐标系**：
   ```javascript
   // 打开.prj文件查看坐标系
   // 或在QGIS中查看图层属性
   ```

2. **验证数据**：
   - 在GIS软件中打开SHP文件
   - 确认有可见的几何对象
   - 检查属性表是否完整

3. **转换坐标系**：
   ```
   使用QGIS：
   1. 右键图层 → 导出 → 保存要素为
   2. 选择坐标系：EPSG:4326 (WGS84)
   3. 保存为新的SHP文件
   ```

---

### 问题3：中文乱码

**症状**：
- 属性表中的中文显示为乱码
- 或显示为方框/问号

**原因**：
- 文件编码不正确
- 缺少 `.cpg` 文件

**解决方案**：

1. **添加CPG文件**：
   ```
   创建一个与SHP文件同名的.cpg文件
   内容为：UTF-8
   ```

2. **转换编码**：
   ```
   使用QGIS：
   1. 打开SHP文件时选择正确编码
   2. 导出为新的SHP文件
   3. 编码选择：UTF-8
   ```

3. **后端配置**：
   ```javascript
   // 在后端配置默认编码
   encoding: 'utf-8'
   ```

---

## 快速诊断

### 5分钟诊断流程

```mermaid
开始
  ↓
文件能在QGIS中打开吗？
  ├─ 否 → 文件损坏，重新导出
  ↓ 是
能看到几何对象吗？
  ├─ 否 → 几何数据为空，检查源数据
  ↓ 是
属性表有数据吗？
  ├─ 否 → 属性缺失，补充属性
  ↓ 是
中文显示正常吗？
  ├─ 否 → 编码问题，添加CPG文件
  ↓ 是
坐标系是WGS84吗？
  ├─ 否 → 转换坐标系
  ↓ 是
重新上传 → 成功！
```

### 诊断命令

**检查文件完整性**：
```bash
# 查看文件列表
ls -l *.shp *.shx *.dbf

# 检查文件大小（不应该为0）
du -h *.shp *.shx *.dbf
```

**查看坐标系**：
```bash
# 查看.prj文件内容
cat *.prj
```

**检查编码**：
```bash
# 查看.cpg文件
cat *.cpg
# 如果不存在，创建它
echo "UTF-8" > filename.cpg
```

---

## 故障排查

### 排查步骤

#### 步骤1：验证文件基础
```
□ 检查文件存在性
  - .shp 文件
  - .shx 文件
  - .dbf 文件

□ 检查文件完整性
  - 文件大小 > 0
  - 文件未损坏
  - 可以在GIS软件中打开

□ 检查文件命名
  - 所有文件主文件名相同
  - 没有特殊字符
  - 文件扩展名小写
```

#### 步骤2：检查数据内容
```
□ 几何数据
  - 有可见的点/线/面
  - 坐标范围合理
  - 没有无效几何

□ 属性数据
  - 属性表有记录
  - 字段名称正确
  - 没有空值（如果不允许）

□ 坐标系统
  - 有.prj文件
  - 坐标系为WGS84或可转换
  - 坐标范围在有效范围内
```

#### 步骤3：测试上传
```
□ 上传前准备
  - 文件打包为ZIP（可选）
  - 检查文件总大小 < 50MB
  - 备份原始文件

□ 上传测试
  - 选择正确的上传按钮
  - 观察进度条
  - 等待完成提示

□ 结果验证
  - 地图上有显示
  - 属性信息正确
  - 中文无乱码
```

---

## 后端配置

### 扫描SHP文件配置

#### 自动扫描
后端可以配置自动扫描特定目录的SHP文件：

```javascript
// server/config.js
module.exports = {
  shpScanPath: './public/data/data_shp',
  shpScanInterval: 60000, // 每60秒扫描一次
  shpAutoLoad: true       // 自动加载新文件
}
```

#### 手动扫描
```javascript
// server/routes/image.js
router.get('/scan-shp', (req, res) => {
  const shpFiles = scanShpDirectory('./public/data/data_shp')
  res.json({ files: shpFiles })
})
```

### 文件处理配置

#### 编码设置
```javascript
const shpOptions = {
  encoding: 'utf-8',
  fallbackEncoding: 'gbk'
}
```

#### 坐标转换
```javascript
const proj4 = require('proj4')

// 定义坐标系转换
proj4.defs('EPSG:4326', '+proj=longlat +datum=WGS84 +no_defs')
proj4.defs('EPSG:3857', '+proj=merc +a=6378137 +b=6378137 ...')

// 转换坐标
const converted = proj4('EPSG:4326', 'EPSG:3857', [lng, lat])
```

#### 大文件处理
```javascript
const multer = require('multer')

const upload = multer({
  limits: {
    fileSize: 50 * 1024 * 1024  // 50MB限制
  },
  fileFilter: (req, file, cb) => {
    const ext = path.extname(file.originalname)
    if (['.shp', '.shx', '.dbf', '.prj', '.cpg'].includes(ext)) {
      cb(null, true)
    } else {
      cb(new Error('不支持的文件类型'))
    }
  }
})
```

---

## 最佳实践

### 准备SHP文件

1. **使用QGIS处理**：
   ```
   1. 在QGIS中打开原始数据
   2. 修复几何错误（如果有）
   3. 选择坐标系：EPSG:4326
   4. 导出为新的Shapefile
   5. 编码选择：UTF-8
   ```

2. **添加必要文件**：
   ```
   - 创建.cpg文件，内容为 "UTF-8"
   - 确保有.prj文件
   - 保持文件命名一致
   ```

3. **验证数据**：
   ```
   - 在QGIS中重新打开导出的文件
   - 检查几何和属性
   - 确认中文显示正常
   ```

### 上传时注意

1. **文件大小**：
   - 建议 < 10MB
   - 大文件考虑简化或分割

2. **网络环境**：
   - 稳定的网络连接
   - 避免在高峰期上传

3. **备份原文件**：
   - 上传前备份
   - 保留原始数据

---

## 工具推荐

### QGIS
- **下载**：https://qgis.org
- **用途**：打开、编辑、转换SHP文件
- **优点**：免费、功能强大、跨平台

### ogr2ogr (GDAL)
- **用途**：命令行转换工具
- **示例**：
  ```bash
  # 转换坐标系
  ogr2ogr -t_srs EPSG:4326 output.shp input.shp
  
  # 转换编码
  ogr2ogr -lco ENCODING=UTF-8 output.shp input.shp
  ```

### Shapefile Viewer
- **在线工具**：https://mapshaper.org
- **用途**：在线查看和简化SHP文件
- **优点**：无需安装软件

---

## 更新日志

### 2025-10-20
- ✅ SHP文件识别功能上线
- ✅ UI优化和错误提示改进
- ✅ 快速指南位置调整
- ✅ 后端扫描配置完成
- ✅ 中文编码问题修复

---

## 技术支持

遇到问题请提供：
1. SHP文件（可以打包为ZIP）
2. 错误截图
3. 浏览器控制台日志
4. 操作步骤描述

---

**文档说明**：本文档整合了所有SHP文件处理相关的说明、问题修复和配置指南。



