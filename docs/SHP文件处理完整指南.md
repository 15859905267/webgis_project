# SHP文件处理完整指南

> **综合文档** - 整合了SHP上传、转换、诊断、流程优化等所有内容  
> **最后更新：** 2025-10-28

---

## 📋 目录

1. [SHP文件基础](#shp文件基础)
2. [上传和识别](#上传和识别)
3. [SHP转KMZ功能](#shp转kmz功能)
4. [常见问题诊断](#常见问题诊断)
5. [快速诊断流程](#快速诊断流程)
6. [后端配置](#后端配置)

---

## SHP文件基础

### 什么是SHP文件？

SHP（Shapefile）是一种常见的地理空间矢量数据格式，通常包含以下文件：

#### 必需文件
- `.shp` - 存储几何形状
- `.shx` - 索引文件
- `.dbf` - 属性数据

#### 可选文件
- `.prj` - 投影信息（强烈推荐）
- `.cpg` - 编码信息（中文需要）
- `.sbn/.sbx` - 空间索引
- `.shp.xml` - 元数据

### 文件要求

1. **完整性** - 必须包含 `.shp`, `.shx`, `.dbf` 三个核心文件
2. **命名** - 所有文件的主文件名必须相同
3. **编码** - 建议使用UTF-8编码
4. **坐标系** - 建议包含 `.prj` 文件说明坐标系

---

## 上传和识别

### 上传流程

#### 步骤1：准备文件
```
将SHP文件夹打包成ZIP
├── filename.shp
├── filename.shx
├── filename.dbf
├── filename.prj
└── filename.cpg  (UTF-8)
```

#### 步骤2：上传
1. 点击"上传SHP文件"按钮
2. 选择ZIP文件
3. （可选）填写元数据信息

#### 步骤3：自动处理
```
上传ZIP
  ↓
自动解压 → data_shp/文件夹名/
  ↓
生成元数据JSON
  ↓
完成
```

#### 步骤4：使用
- 在主控台选择SHP文件
- 或转换为KMZ/GeoJSON
- 或下载ZIP包

### UI优化

- ✅ 友好的上传界面
- ✅ 实时进度提示
- ✅ 错误信息明确
- ✅ 支持批量上传
- ✅ 自动生成元数据

---

## SHP转KMZ功能

### 功能概述

**一键转换：** SHP → GeoJSON → KMZ

**自动处理：**
1. 坐标系转换（任意坐标系 → WGS84）
2. 面积计算并保存
3. 几何验证和修复
4. 生成KMZ和GeoJSON两种格式

### 转换流程优化

#### 完整流程
```
SHP文件
  ↓ 1. GeoPandas读取
检测坐标系
  ↓ 2. 坐标转换
WGS84 (EPSG:4326)
  ↓ 3. 面积计算
添加area_m2/area_mu
  ↓ 4. 几何验证
过滤无效坐标
  ↓ 5. 保存GeoJSON
包含面积数据
  ↓ 6. 生成KML
符合Google Earth标准
  ↓ 7. 压缩KMZ
完成
```

### 使用方式

#### 方式1：数据管理界面
1. 在识别结果列表找到SHP文件
2. 点击"转换格式"按钮
3. 选择"转换为KMZ"
4. 点击"开始转换"

#### 方式2：批量转换（开发中）
- 选择多个SHP文件
- 一键批量转换
- 后台并行处理

### 转换特性

**自动坐标转换：**
```
支持输入：
- EPSG:3857 (Web Mercator)
- EPSG:32645 (UTM Zone 45N)
- EPSG:2000+ (其他投影)

自动转换为：
- EPSG:4326 (WGS84) ✅
```

**自动面积计算：**
```json
{
  "properties": {
    "name": "地块1",
    "area_m2": 12345.67,  // 自动计算
    "area_mu": 18.52      // 自动计算
  }
}
```

**几何验证：**
- 过滤无效坐标（NaN, Infinity）
- 验证坐标范围（经度±180°，纬度±90°）
- 确保多边形闭合
- 跳过无效要素

---

## 常见问题诊断

### 问题1：文件上传失败

**症状：**
- 上传后显示"文件格式错误"
- 或显示"文件不完整"

**原因：**
1. 缺少必需的文件（.shp, .shx, .dbf）
2. 文件损坏
3. 文件命名不一致

**解决方案：**
```
✅ 检查清单：
1. [ ] .shp 文件存在
2. [ ] .shx 文件存在
3. [ ] .dbf 文件存在
4. [ ] 所有文件主文件名相同
5. [ ] 文件未损坏（可以用QGIS打开）
```

---

### 问题2：识别结果为空

**症状：**
- 文件上传成功
- 但地图上没有显示任何内容

**原因：**
1. 坐标系不匹配
2. 几何数据为空
3. 属性字段缺失

**解决方案：**

**1. 检查坐标系：**
- 打开.prj文件查看坐标系
- 或在QGIS中查看图层属性

**2. 验证数据：**
- 在GIS软件中打开SHP文件
- 确认有可见的几何对象
- 检查属性表是否完整

**3. 转换坐标系（如需要）：**
```
使用QGIS：
1. 右键图层 → 导出 → 保存要素为
2. 选择坐标系：EPSG:4326 (WGS84)
3. 保存为新的SHP文件
```

---

### 问题3：中文乱码

**症状：**
- 属性表中的中文显示为乱码
- 或显示为方框/问号

**原因：**
- 文件编码不正确
- 缺少 `.cpg` 文件

**解决方案：**

**1. 添加CPG文件：**
```bash
# 创建一个与SHP文件同名的.cpg文件
# 文件内容为：UTF-8
echo "UTF-8" > filename.cpg
```

**2. 转换编码（使用QGIS）：**
```
1. 打开SHP文件时选择正确编码
2. 导出为新的SHP文件
3. 编码选择：UTF-8
```

---

### 问题4：转换为KMZ后无法在Google Earth中显示

**症状：**
- KMZ文件可以打开
- 但显示0个要素或报错

**诊断步骤：**

**1. 检查后端日志：**
```
查找以下信息：
- 原始坐标系是什么？
- 是否成功转换为WGS84？
- 有多少个有效/无效要素？
```

**2. 常见原因和解决：**

| 原因 | 日志特征 | 解决方案 |
|------|---------|----------|
| 坐标系错误 | `0个有效, 741个无效` | 检查源文件坐标系 |
| 几何无效 | `跳过N个无效要素` | 使用QGIS修复几何 |
| 坐标超范围 | `坐标验证失败` | 检查是否为投影坐标 |

**3. 使用QGIS验证：**
```
1. 在QGIS中打开原始SHP
2. 检查坐标系和几何完整性
3. 使用"修复几何"工具
4. 导出为WGS84坐标系
5. 重新上传和转换
```

---

## 快速诊断流程

### 5分钟诊断清单

```
开始
  ↓
文件能在QGIS中打开吗？
  ├─ 否 → 文件损坏，重新导出
  ↓ 是
能看到几何对象吗？
  ├─ 否 → 几何数据为空，检查源数据
  ↓ 是
属性表有数据吗？
  ├─ 否 → 属性缺失，补充属性
  ↓ 是
中文显示正常吗？
  ├─ 否 → 编码问题，添加CPG文件
  ↓ 是
坐标系是WGS84吗？
  ├─ 否 → 转换坐标系
  ↓ 是
重新上传 → 成功！
```

### 诊断命令

**检查文件完整性：**
```bash
# 查看文件列表
ls -l *.shp *.shx *.dbf

# 检查文件大小（不应该为0）
du -h *.shp *.shx *.dbf
```

**查看坐标系：**
```bash
# 查看.prj文件内容
cat *.prj
```

**检查编码：**
```bash
# 查看.cpg文件
cat *.cpg

# 如果不存在，创建它
echo "UTF-8" > filename.cpg
```

---

## 后端配置

### 扫描SHP文件配置

#### 自动扫描
```javascript
// server/config.js
module.exports = {
  shpScanPath: './public/data/data_shp',
  shpScanInterval: 60000, // 每60秒扫描一次
  shpAutoLoad: true       // 自动加载新文件
}
```

#### 手动扫描
```javascript
// server/routes/image.js
router.get('/scan-shp', (req, res) => {
  const shpFiles = scanShpDirectory('./public/data/data_shp')
  res.json({ files: shpFiles })
})
```

### 文件处理配置

#### 编码设置
```javascript
const shpOptions = {
  encoding: 'utf-8',
  fallbackEncoding: 'gbk'
}
```

#### 坐标转换
```javascript
const proj4 = require('proj4')

// 定义坐标系转换
proj4.defs('EPSG:4326', '+proj=longlat +datum=WGS84 +no_defs')
proj4.defs('EPSG:3857', '+proj=merc +a=6378137 +b=6378137 ...')

// 转换坐标
const converted = proj4('EPSG:4326', 'EPSG:3857', [lng, lat])
```

#### 大文件处理
```javascript
const multer = require('multer')

const upload = multer({
  limits: {
    fileSize: 50 * 1024 * 1024  // 50MB限制
  },
  fileFilter: (req, file, cb) => {
    const ext = path.extname(file.originalname)
    if (['.shp', '.shx', '.dbf', '.prj', '.cpg'].includes(ext)) {
      cb(null, true)
    } else {
      cb(new Error('不支持的文件类型'))
    }
  }
})
```

---

## 最佳实践

### 准备SHP文件

**使用QGIS处理：**
```
1. 在QGIS中打开原始数据
2. 修复几何错误（如果有）
3. 选择坐标系：EPSG:4326
4. 导出为新的Shapefile
5. 编码选择：UTF-8
```

**添加必要文件：**
```
- 创建.cpg文件，内容为 "UTF-8"
- 确保有.prj文件
- 保持文件命名一致
```

**验证数据：**
```
- 在QGIS中重新打开导出的文件
- 检查几何和属性
- 确认中文显示正常
```

### 上传时注意

1. **文件大小** - 建议 < 10MB
2. **网络环境** - 稳定的网络连接
3. **备份原文件** - 上传前备份

---

## 工具推荐

### QGIS
- **下载**：https://qgis.org
- **用途**：打开、编辑、转换SHP文件
- **优点**：免费、功能强大、跨平台

### ogr2ogr (GDAL)
**命令行转换工具：**
```bash
# 转换坐标系
ogr2ogr -t_srs EPSG:4326 output.shp input.shp

# 转换编码
ogr2ogr -lco ENCODING=UTF-8 output.shp input.shp
```

### Shapefile Viewer
- **在线工具**：https://mapshaper.org
- **用途**：在线查看和简化SHP文件
- **优点**：无需安装软件

---

## 更新日志

**2025-10-28**
- ✅ 整合所有SHP相关文档
- ✅ 添加完整的诊断流程

**2025-10-27**
- ✅ SHP转KMZ流程优化
- ✅ 自动坐标转换
- ✅ 自动面积计算

**2025-10-22**
- ✅ SHP文件夹上传功能
- ✅ ZIP解压双层嵌套修复
- ✅ 元数据自动生成

**2025-10-20**
- ✅ SHP文件识别功能上线
- ✅ UI优化和错误提示改进
- ✅ 后端扫描配置完成

---

## 技术支持

遇到问题请提供：
1. SHP文件（可以打包为ZIP）
2. 错误截图
3. 浏览器控制台日志
4. 操作步骤描述

---

**文档说明：** 本文档整合了所有SHP文件处理相关的说明、诊断指南和配置说明。
