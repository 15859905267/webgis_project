# 🚀 快速部署参考卡

> 已熟悉Docker的用户专用，适合快速查阅

---

## 一、前置准备

### 服务器要求
- **系统**：Ubuntu 22.04 LTS
- **配置**：最少 2核4G，推荐 2核8G
- **带宽**：最少 5M
- **开放端口**：22, 80, 443

### 域名（可选）
- 购买域名并完成实名认证
- 添加 A 记录指向服务器 IP

---

## 二、服务器初始化

```bash
# 更新系统
sudo apt-get update && sudo apt-get upgrade -y

# 安装基础工具
sudo apt-get install -y curl wget git vim

# 配置防火墙
sudo ufw allow 22
sudo ufw allow 80
sudo ufw allow 443
sudo ufw enable
```

---

## 三、安装Docker

```bash
# 一键安装
curl -fsSL https://get.docker.com | bash

# 启动服务
sudo systemctl start docker
sudo systemctl enable docker

# 验证
docker --version
docker compose version
```

---

## 四、部署项目

```bash
# 1. 克隆项目
cd /root
git clone <your-repo-url> webgis_project
cd webgis_project

# 2. 创建数据目录
mkdir -p public/data
chmod -R 755 public/data

# 3. 启动服务（首次启动需10-20分钟）
docker compose up -d --build

# 4. 查看状态
docker compose ps

# 5. 查看日志
docker compose logs -f
```

---

## 五、配置域名（可选）

```bash
# 1. DNS解析：在域名控制台添加 A 记录

# 2. 修改 Nginx 配置
nano nginx.conf
# 修改 server_name localhost; 为你的域名

# 3. 重启前端
docker compose restart frontend
```

---

## 六、配置HTTPS（可选）

```bash
# 1. 安装 Certbot
sudo apt-get install -y certbot

# 2. 停止前端（释放80端口）
docker compose stop frontend

# 3. 获取证书
sudo certbot certonly --standalone -d 你的域名 -m 你的邮箱 --agree-tos

# 4. 修改 docker-compose.yml
# 在 frontend 的 volumes 下添加：
# - /etc/letsencrypt:/etc/letsencrypt:ro

# 5. 修改 nginx.conf（参考完整指南）

# 6. 重启服务
docker compose up -d --build

# 7. 设置自动续期
sudo crontab -e
# 添加：0 0 1 * * certbot renew --quiet && docker compose -f /root/webgis_project/docker-compose.yml restart frontend
```

---

## 七、常用命令

```bash
# 启动
docker compose up -d

# 停止
docker compose down

# 重启
docker compose restart

# 重新构建
docker compose up -d --build

# 查看日志
docker compose logs -f

# 查看状态
docker compose ps

# 进入容器
docker exec -it webgis-backend sh

# 备份数据
tar -czf backup-$(date +%Y%m%d).tar.gz public/data/

# 清理Docker
docker system prune -a
```

---

## 八、项目文件结构

```
webgis_project/
├── Dockerfile              # 前端镜像
├── docker-compose.yml      # 服务编排
├── nginx.conf             # Nginx配置
├── .dockerignore          # Docker忽略文件
├── server/
│   ├── Dockerfile         # 后端镜像
│   └── .dockerignore
├── public/data/           # 数据目录（持久化）
└── docs/                  # 文档
```

---

## 九、验证部署

```bash
# 后端健康检查
curl http://localhost:8080/health

# 前端访问
curl http://localhost

# 浏览器访问
http://服务器IP
# 或
http://你的域名
```

---

## 十、故障排查

| 问题 | 命令 |
|-----|------|
| 查看容器状态 | `docker compose ps` |
| 查看日志 | `docker compose logs -f` |
| 重启服务 | `docker compose restart` |
| 清理缓存 | `docker system prune -a` |
| 查看端口占用 | `sudo netstat -tulpn \| grep :80` |
| 查看磁盘空间 | `df -h` |
| 进入容器调试 | `docker exec -it webgis-backend sh` |

---

## 十一、性能优化建议

```bash
# 1. 限制容器资源（修改 docker-compose.yml）
services:
  backend:
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G

# 2. 配置 Docker 日志轮转
# 修改 /etc/docker/daemon.json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}

# 3. 定期清理
docker system prune -a --volumes
```

---

## 十二、安全建议

```bash
# 1. 修改 SSH 端口（可选）
sudo vim /etc/ssh/sshd_config
# 修改 Port 22 为其他端口

# 2. 禁用 root 登录（可选）
# PermitRootLogin no

# 3. 配置 fail2ban 防爆破
sudo apt-get install fail2ban

# 4. 定期更新
sudo apt-get update && sudo apt-get upgrade -y
docker compose pull
docker compose up -d --build
```

---

## 📞 快速帮助

- **完整指南**：`docs/Docker部署完全指南-零基础版.md`
- **项目文档**：`docs/README.md`
- **后端健康检查**：`http://IP:8080/health`

---

**部署时间线：**
- ⏱️ 服务器初始化：5-10分钟
- ⏱️ 安装Docker：5分钟
- ⏱️ 首次构建：10-20分钟
- ⏱️ 配置域名：10分钟-2小时（DNS生效）
- ⏱️ 配置HTTPS：5分钟

**总计：30分钟 - 2.5小时**

