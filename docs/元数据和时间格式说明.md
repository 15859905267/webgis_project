# 元数据和时间格式说明

## 元数据文件位置

### SHP 文件
- **位置**：`public/data/data_shp/文件夹名/文件名.json`
- **示例**：`public/data/data_shp/shp_2024_kle_vh_kndvi/shp_2024_kle_vh_kndvi.json`

### GeoJSON 文件
- **位置**：`public/data/data_geojson/文件名.json`
- **示例**：`public/data/data_geojson/YZC_reclassified2.json`

### KMZ 文件
- **位置**：`public/data/data_kmz/文件夹路径/文件名.json`
- **示例**：`public/data/data_kmz/planting_situation/YZC/YZC.json`

### 影像数据
- **位置**：`public/data/imageData.json`
- **说明**：所有影像（TIF文件）的元数据都存储在这个统一的 JSON 文件中，是一个数组格式

## 元数据文件结构

```json
{
  "year": 2024,
  "period": 1,
  "regionCode": "YZC",
  "regionName": "原种场",
  "recognitionType": "planting_situation",
  "taskName": "YZC_reclassified2",
  "createdAt": "2025-10-22T15:14:21.683Z",
  "uploadTime": "2025-10-22T15:14:21.683Z",
  "updatedAt": "2025-10-22T15:14:21.683Z"
}
```

## 时间字段说明

### 1. createdAt（创建时间）
- **含义**：文件首次上传或创建的时间
- **格式**：ISO 8601 标准格式（UTC时间）
- **示例**：`"2025-10-22T15:14:21.683Z"`
- **特点**：一旦创建就不会改变，即使后续编辑元数据也会保留

### 2. uploadTime（上传时间）
- **含义**：文件上传到服务器的时间
- **格式**：ISO 8601 标准格式（UTC时间）
- **示例**：`"2025-10-22T15:14:21.683Z"`
- **特点**：与 `createdAt` 通常相同

### 3. updatedAt（更新时间）
- **含义**：元数据最后一次被修改的时间
- **格式**：ISO 8601 标准格式（UTC时间）
- **示例**：`"2025-10-22T15:14:21.683Z"`
- **特点**：每次编辑元数据时都会更新

## 时间格式详解

### 为什么元数据文件中的时间和前端显示的不一样？

这是**正常现象**，原因如下：

#### 元数据文件中的时间格式
```json
"createdAt": "2025-10-22T15:14:21.683Z"
```
- **格式**：ISO 8601 标准格式
- **时区**：UTC（世界协调时）
- **Z 后缀**：表示零时区（UTC+0）

#### 前端显示的时间格式
```
2025/10/22 23:14:21
```
- **格式**：本地化格式（`toLocaleString('zh-CN')`）
- **时区**：本地时区（中国是 UTC+8）
- **转换**：15:14 + 8小时 = 23:14

### 时间转换示例

| 元数据文件（UTC）           | 前端显示（UTC+8）      | 时差      |
|---------------------------|---------------------|----------|
| 2025-10-22T15:14:21.683Z  | 2025/10/22 23:14:21 | +8小时    |
| 2025-10-22T00:00:00.000Z  | 2025/10/22 08:00:00 | +8小时    |
| 2025-10-21T16:00:00.000Z  | 2025/10/22 00:00:00 | +8小时    |

### 为什么使用 ISO 8601 格式？

1. **国际标准**：ISO 8601 是国际通用的日期时间标准
2. **时区无关**：统一使用 UTC 时间存储，避免时区混淆
3. **排序友好**：可以直接按字符串排序
4. **跨平台兼容**：所有编程语言都支持
5. **精确性**：包含毫秒级精度

### 如何手动转换时间？

#### 从 UTC 转本地时间（东八区）
```javascript
const utcTime = "2025-10-22T15:14:21.683Z"
const localTime = new Date(utcTime).toLocaleString('zh-CN')
console.log(localTime) // "2025/10/22 23:14:21"
```

#### 从本地时间转 UTC
```javascript
const now = new Date()
const utcTime = now.toISOString()
console.log(utcTime) // "2025-10-22T15:14:21.683Z"
```

## 元数据生成流程

### 上传 SHP 文件时（ZIP 压缩包）

1. **解压 ZIP 文件**到 `data_shp/文件夹名/`
2. **自动生成元数据文件**（即使不填写元数据表单）
   - 如果填写了元数据表单：使用用户提供的值
   - 如果没有填写：使用默认值（年份=当前年份，期次=1等）
3. **保存元数据文件**为 `文件名.json`

### 编辑元数据时

1. **读取已有的元数据文件**
2. **保留原有的时间戳**：
   - `createdAt`：保留原值
   - `uploadTime`：保留原值
   - `updatedAt`：更新为当前时间
3. **更新其他字段**：年份、期次、区域、识别类型等
4. **保存更新后的元数据文件**

## 常见问题

### Q1: 为什么上传时没有元数据文件？
**A**: 新版本已修复，现在上传 SHP ZIP 文件时会自动生成元数据文件，即使不填写元数据表单。

### Q2: 编辑元数据后，创建时间会改变吗？
**A**: 不会。`createdAt` 字段会被保留，只有 `updatedAt` 会更新。

### Q3: 能否手动修改元数据文件？
**A**: 可以，但建议通过前端"编辑信息"功能来修改，以确保格式正确。

### Q4: 时间格式可以改成中国时区吗？
**A**: 不建议。后端统一使用 UTC 时间存储是最佳实践。前端显示时会自动转换为本地时区。

### Q5: 如何查看某个文件的元数据？
**A**: 
- **方式1**：在识别结果列表中点击"编辑信息"按钮
- **方式2**：直接打开对应的 JSON 文件查看

## 技术细节

### 后端时间生成
```javascript
// 生成 ISO 8601 UTC 时间
const now = new Date().toISOString()
// 结果: "2025-10-22T15:14:21.683Z"
```

### 前端时间显示
```javascript
// 将 ISO 时间转换为本地时间
const createTime = new Date(savedMetadata.createdAt).toLocaleString('zh-CN')
// 结果: "2025/10/22 23:14:21"
```

### 时间戳获取
```javascript
// 获取时间戳（用于排序）
const timestamp = new Date(savedMetadata.createdAt).getTime()
// 结果: 1729611261683
```

## 总结

- **元数据文件**：与数据文件同名，扩展名为 `.json`，存储在同一目录
- **时间格式**：后端使用 ISO 8601 UTC 格式存储，前端显示时自动转换为本地时区
- **时间字段**：`createdAt`（创建时间）、`uploadTime`（上传时间）、`updatedAt`（更新时间）
- **自动生成**：上传时自动生成元数据文件，编辑时保留原有时间戳
- **时区差异**：UTC 时间 + 8小时 = 中国时间（东八区）

