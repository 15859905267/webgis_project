# gridcode字段支持修复

## 📅 修复日期
2025-10-20

## 🐛 问题描述

**症状**：
- 时序分析所有地块显示"无变化"
- 图表显示全部为"未知类型(0)"
- 作物分布只有一种类型：未知

**根本原因**：
- 代码读取 `feature.properties.type` 字段作为作物类型
- 但实际GeoJSON文件中使用 `feature.properties.gridcode` 字段存储作物类型
- 导致读取到的值为 `undefined` 或 `0`

**用户反馈**：
> "我的geojson不是type字段表示为作物类型 而是gridcode这个字段"

---

## ✅ 修复方案

### 修改文件
`src/utils/temporalAnalysis.js`

### 修改内容

**修改前**：
```javascript
const cropType = feature.properties?.type || feature.properties?.Type || 0
```

**修改后**：
```javascript
// 优先读取gridcode字段，其次是type/Type字段
const cropType = feature.properties?.gridcode || feature.properties?.GRIDCODE || 
                 feature.properties?.type || feature.properties?.Type || 0
```

### 字段优先级
1. `gridcode` (小写)
2. `GRIDCODE` (大写)
3. `type` (小写)
4. `Type` (首字母大写)
5. `0` (默认值)

---

## 🔍 诊断日志增强

新增了 `fieldUsed` 字段，可以看到实际使用了哪个字段：

```javascript
console.log(`📋 时间点 1 的第一个地块示例:`, {
  plotId: 1,
  cropType: 2,
  cropName: "棉花",
  properties: {...},
  fieldUsed: 'gridcode'  // ← 显示使用了哪个字段
})
```

**可能的值**：
- `'gridcode'` - 使用了 gridcode 字段 ✅
- `'GRIDCODE'` - 使用了 GRIDCODE 字段 ✅
- `'type'` - 使用了 type 字段
- `'Type'` - 使用了 Type 字段
- `'none'` - 所有字段都不存在 ❌

---

## 🎯 GeoJSON 数据格式

### 标准格式（现在支持）

**格式A：使用 gridcode**
```json
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "properties": {
        "id": 1,
        "gridcode": 2,  // ← 作物类型（棉花）
        "area": 100
      },
      "geometry": {...}
    }
  ]
}
```

**格式B：使用 type**
```json
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "properties": {
        "id": 1,
        "type": 2,  // ← 作物类型（棉花）
        "area": 100
      },
      "geometry": {...}
    }
  ]
}
```

**都支持！** ✅

---

## 📊 作物类型映射表

```javascript
GRIDCODE值 → 作物名称
1  → 裸地
2  → 棉花
3  → 小麦
4  → 玉米
5  → 番茄
6  → 甜菜
7  → 打瓜
8  → 辣椒
9  → 籽用葫芦
10 → 其它耕地
```

**注意**：
- gridcode的值应该在 1-10 范围内
- 如果值为 0 或不在范围内，会显示为"未知类型(X)"

---

## 🧪 测试验证步骤

### 步骤1：强制刷新浏览器
```
Ctrl + Shift + R
```

### 步骤2：重新执行时序分析
1. 进入"任务管理"
2. 选择 2 个不同时期的识别结果
3. 点击"执行时序分析"

### 步骤3：查看控制台输出

**期望看到**：
```javascript
📋 时间点 1 的第一个地块示例: {
  plotId: 1,
  cropType: 2,          // ← 不再是 0！
  cropName: "棉花",     // ← 不再是 "未知类型(0)"！
  properties: {
    id: 1,
    gridcode: 2,        // ← 原始数据
    area: 100
  },
  fieldUsed: 'gridcode' // ← 使用了 gridcode 字段
}

📝 第一个地块示例 (ID: 1): {
  cropHistory: ["棉花", "小麦"],  // ← 显示具体作物名称
  changeCount: 1,                  // ← 有变化！
  timeline: ["任务A: 棉花", "任务B: 小麦"]
}

🌾 时间点 1 的作物分布: {
  "棉花": 2000,      // ← 显示具体作物
  "小麦": 1500,
  "玉米": 1000,
  "其它耕地": 1719
}

📈 变化统计: 3000/6219 个地块有变化  // ← 不再是 0！
```

### 步骤4：查看结果

**时间轴与统计**：
- ✅ 地图上应该显示不同颜色（有变化的地块）
- ✅ 点击地块应该显示具体作物名称
- ✅ 变化程度图例应该正常显示

**图表分析**：
- ✅ 作物分布饼图显示具体作物（不是"未知"）
- ✅ 作物转换流程图显示转换关系（如"棉花 → 小麦"）
- ✅ 轮作模式显示合理的作物序列

---

## 🔧 如果仍然显示"未知"

### 检查1：确认gridcode字段存在

在控制台执行：
```javascript
// 检查GeoJSON文件
const response = await fetch('/api/readGeojson?filename=你的文件名.geojson')
const data = await response.json()
console.log('第一个地块properties:', data.features[0].properties)
```

**查看输出**：
```javascript
{
  id: 1,
  gridcode: 2,  // ← 应该有这个字段
  area: 100
}
```

### 检查2：确认gridcode值在1-10范围内

```javascript
// 检查所有唯一的gridcode值
const uniqueGridcodes = new Set()
data.features.forEach(f => {
  if (f.properties.gridcode) {
    uniqueGridcodes.add(f.properties.gridcode)
  }
})
console.log('所有gridcode值:', Array.from(uniqueGridcodes).sort())
```

**期望输出**：
```javascript
[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
```

**如果看到**：
```javascript
[0]  // ❌ 只有0，说明数据无效
[]   // ❌ 空数组，说明没有gridcode字段
```

### 检查3：查看fieldUsed值

从控制台日志中查看：
```javascript
fieldUsed: 'gridcode'  // ✅ 正确，使用了gridcode
fieldUsed: 'none'      // ❌ 错误，没有找到任何字段
```

---

## 🎯 常见问题

### Q1: 为什么我的文件用gridcode而不是type？

**A**: 这取决于数据来源和处理工具：
- ArcGIS栅格转矢量通常使用 `gridcode`
- QGIS可能使用 `type` 或其他字段名
- 手动创建的GeoJSON可以使用任意字段名

现在代码支持多种字段名，优先尝试 `gridcode`。

### Q2: 如果我的字段名是其他的怎么办？

**A**: 联系开发者添加支持，或者：
1. 手动修改GeoJSON文件，添加 `gridcode` 字段
2. 或者重命名现有字段为 `gridcode`

### Q3: gridcode的值必须是1-10吗？

**A**: 是的，根据当前的 `CROP_TYPE_MAP`：
- 值必须在 1-10 范围内
- 对应 10 种作物类型
- 超出范围会显示为"未知类型(X)"

---

## 📝 后续优化建议

### 建议1：自动字段检测

未来可以添加自动检测功能：
```javascript
// 自动检测作物类型字段
const detectCropField = (properties) => {
  const possibleFields = ['gridcode', 'GRIDCODE', 'type', 'Type', 'crop', 'class']
  for (const field of possibleFields) {
    if (properties[field] && properties[field] >= 1 && properties[field] <= 10) {
      return field
    }
  }
  return null
}
```

### 建议2：数据验证

上传时验证GeoJSON数据：
- 检查是否有作物类型字段
- 检查值是否在有效范围
- 给出友好的提示

---

## ✅ 验证清单

- [ ] 强制刷新浏览器（Ctrl + Shift + R）
- [ ] 重新执行时序分析
- [ ] 控制台显示 `fieldUsed: 'gridcode'`
- [ ] cropType 不再是 0
- [ ] cropName 显示具体作物名称
- [ ] cropHistory 显示作物变化序列
- [ ] changeCount 大于 0（如果确实有变化）
- [ ] 地图显示不同颜色的地块
- [ ] 图表显示具体作物而不是"未知"
- [ ] 作物转换流程图正常显示

---

## 🎉 总结

**问题**：字段名不匹配
- 代码：读取 `type`
- 数据：使用 `gridcode`

**解决**：支持多种字段名
- 优先级：`gridcode` > `GRIDCODE` > `type` > `Type`
- 兼容新旧数据格式
- 添加诊断日志

**效果**：
- ✅ 时序分析正常显示作物变化
- ✅ 图表显示具体作物名称
- ✅ 支持多种GeoJSON格式

**请立即测试并反馈结果！**


