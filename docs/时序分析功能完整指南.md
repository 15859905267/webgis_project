# 时序分析功能完整指南

## 📅 最后更新
2025年10月21日

---

## 目录

1. [功能概述](#功能概述)
2. [使用指南](#使用指南)
3. [地图可视化](#地图可视化)
4. [图表分析](#图表分析)
5. [作物转换关系筛选](#作物转换关系筛选)
6. [性能优化](#性能优化)
7. [交互优化](#交互优化)

---

## 功能概述

时序分析功能用于分析多个时间点的作物分布变化，识别地块的作物变化模式、轮作规律等。

### 核心功能

- 🗺️ **时序变化地图**：可视化展示地块变化
- 📊 **统计分析**：变化频率、作物分布等统计
- 📈 **图表展示**：作物转换、轮作模式、分布趋势
- 🔍 **转换关系筛选**：按作物转换类型筛选地块
- 📱 **地块定位**：点击地块列表定位到地图
- 📄 **PDF报告导出**：完整的分析报告

---

## 使用指南

### 基本流程

```mermaid
1. 上传多个时期的图像
   ↓
2. 进行时序分析
   ↓
3. 查看地图与统计
   ↓
4. 查看图表分析
   ↓
5. 使用转换关系筛选
   ↓
6. 导出PDF报告
```

### 详细步骤

#### 1. 准备数据
- 至少2个时间点的作物识别图像
- 建议3-5个时间点以获得更好的分析效果
- 图像需要空间对齐（相同区域）

#### 2. 开始分析
1. 进入"任务管理"界面
2. 创建时序分析任务
3. 选择多个时期的图像
4. 等待分析完成

#### 3. 查看结果
1. 进入"结果查看和比对"界面
2. 选择时序分析结果
3. 切换"地图与统计"和"图表分析"标签页

---

## 地图可视化

### 时序变化地图

#### 功能特性
- ✅ 颜色编码表示变化程度
- ✅ 多种底图支持（高德路网、影像、无底图）
- ✅ 图例显示变化等级
- ✅ 缩放和平移控制

#### 变化程度分级
```
绿色 ━━ 无变化（0次）
黄色 ━━ 低频变化（1次）
橙色 ━━ 中频变化（2次）
红色 ━━ 高频变化（3+次）
```

#### 地块交互
- **点击地块**：显示详情面板
- **详情内容**：
  - 基本信息（名称、ID、面积）
  - 变化统计（次数、起始/结束作物）
  - 时序变化轨迹（时间线）

#### 底图选择
1. **高德路网**：显示道路、地名等
2. **高德影像**：卫星影像底图
3. **无底图**：仅显示地块（推荐导出PDF时使用）

---

## 图表分析

### 1. 作物分布图表
- **内容**：各时期的作物面积分布
- **图表类型**：饼图/柱状图
- **数据**：作物类型、面积、百分比

### 2. 作物转换流向图
- **内容**：作物之间的转换关系
- **展示**：TOP20最常见的转换
- **数据**：起始作物 → 结束作物（地块数量）

### 3. 作物轮作模式分析
- **内容**：完整的作物轮作序列
- **展示**：TOP15最常见的轮作模式
- **数据**：完整序列（如 "小麦 → 打瓜 → 棉花"）

### 4. 未变化地块作物类型分析
- **内容**：保持不变的地块作物统计
- **数据**：各作物的未变化地块数量和占比

### 5. 地块变化频率分布
- **内容**：变化次数的统计
- **图表**：柱状图
- **数据**：各变化次数的地块数量

---

## 作物转换关系筛选

### 功能概述
按作物转换类型筛选地块，支持精准定位和分析。

### 使用方法

#### 1. 进入界面
- 打开"结果查看和比对"界面
- 地图下方看到"作物转换关系筛选"卡片
- 右侧"变化地块列表"显示引导提示

#### 2. 选择转换类型
1. 点击筛选器下拉框
2. 查看所有转换类型及数量（如"裸地 → 棉花 (45个)"）
3. 选择一种转换类型

#### 3. 查看筛选结果
- 右侧地块列表自动显示符合条件的地块
- 列表标题显示筛选数量
- 筛选器下方显示当前筛选信息

#### 4. 定位地块
1. 在地块列表中点击任意地块
2. 地图自动缩放并定位到该地块
3. 显示地块详情面板
4. 该地块在列表中高亮显示

#### 5. 清除筛选
- 点击"清除筛选"按钮
- 或点击下拉框的清空按钮（×）
- 地块列表返回初始状态
- 地图自动缩放至全局范围

### 界面示例

**初始状态**：
```
┌─────────────────────────────────────┐
│ 变化地块列表                         │
├─────────────────────────────────────┤
│         🔍                          │
│   请先选择作物转换关系               │
│   👆 在左侧"作物转换关系筛选"中      │
│   选择一种转换类型                   │
└─────────────────────────────────────┘
```

**筛选后**：
```
┌─────────────────────────────────────┐
│ 变化地块列表 🔍                45    │
├─────────────────────────────────────┤
│ 地块 1        2次 📍                │
│ 裸地 → 棉花                         │
│                                     │
│ 地块 2        1次 📍                │
│ 裸地 → 棉花                         │
└─────────────────────────────────────┘
```

### 设计理念

1. **引导式交互**：
   - 初始不显示地块，避免信息过载
   - 明确提示如何使用筛选功能

2. **精准筛选**：
   - 基于起始和结束作物精确匹配
   - 清晰的数量统计

3. **智能联动**：
   - 筛选 → 列表更新
   - 点击地块 → 地图定位
   - 清除筛选 → 回到初始状态

---

## 性能优化

### 数据处理优化
- ✅ 轨迹数据预处理
- ✅ 变化检测算法优化
- ✅ 大数据量分页加载

### 地图渲染优化
- ✅ 矢量图层优化
- ✅ 样式缓存
- ✅ 按需渲染

### 图表加载优化
- ✅ 数据聚合
- ✅ 懒加载
- ✅ 虚拟滚动

---

## 交互优化

### 地图交互
1. **点击地块**：
   - 显示详情面板
   - 面板可拖拽移动
   - 显示时序变化轨迹

2. **缩放控制**：
   - 鼠标滚轮缩放
   - "缩放至"按钮：缩放到全部地块范围
   - 双击地块：缩放到该地块

3. **底图切换**：
   - 下拉菜单选择底图类型
   - 实时切换，无需刷新

### 地块列表交互
1. **列表滚动**：
   - 固定高度，内部滚动
   - 显示地块数量

2. **地块卡片**：
   - 显示基本信息
   - 变化次数标签
   - 作物转换流向
   - 完整变化序列

3. **高亮反馈**：
   - 鼠标悬停：淡蓝色背景
   - 选中状态：深蓝色背景 + 阴影

### 筛选器交互
1. **下拉选择**：
   - 支持搜索（filterable）
   - 显示每种转换的数量
   - 按数量降序排列

2. **状态提示**：
   - 选中时显示筛选信息
   - 未选中时显示引导提示

3. **清除操作**：
   - "清除筛选"按钮
   - 下拉框内置清空按钮
   - 清除后地图缩放至全局

---

## 数据质量

### 质量指标
- **地块匹配率**：能在所有时期找到对应数据的地块百分比
- **数据完整性**：各时期的地块数量统计
- **变化准确性**：基于严格的几何匹配和属性对比

### 质量警告
系统会自动检测并提示：
- ⚠️ 各时期地块数量不一致
- ⚠️ 地块匹配率低于85%
- ⚠️ 存在无效或缺失数据

---

## 分析结果持久化

### 存储位置
```
public/data/data_analysis_results/
  ├── difference/      # 差异检测结果
  ├── temporal/        # 时序分析结果
  └── reports/         # PDF报告
```

### 数据结构
```json
{
  "taskName": "任务名称",
  "analysisTime": "2025-10-20 10:30:00",
  "timePoints": [...],
  "features": [...],
  "trajectories": [...],
  "changeStats": {...},
  "cropDistribution": [...],
  "transitions": [...],
  "rotationPatterns": [...]
}
```

### 数据管理
- 结果自动保存
- 支持查看历史分析
- 可以重新加载查看
- 支持删除和导出

---

## 注意事项

1. **数据准备**：
   - 确保各时期图像对应同一区域
   - 地块ID或名称应保持一致
   - 坐标系统应相同

2. **性能考虑**：
   - 地块数量建议 < 1000
   - 时间点建议 < 10
   - 大数据量可能需要较长处理时间

3. **筛选功能**：
   - 转换类型基于起始和结束作物
   - 不考虑中间的变化过程
   - 清除筛选会重置地图视野

4. **PDF导出**：
   - 建议使用"无底图"模式
   - 导出前检查数据完整性
   - 文件大小通常 < 5MB

---

## 技术支持

### 常见问题

**Q: 时序分析需要多长时间？**
A: 取决于数据量，通常几秒到几十秒。

**Q: 为什么有些地块显示"未匹配"？**
A: 该地块在某些时期缺失数据或几何不匹配。

**Q: 如何提高地块匹配率？**
A: 
1. 确保各时期使用相同的地块划分
2. 使用相同的坐标系统
3. 保持地块ID或名称一致

**Q: 筛选功能为什么初始不显示地块？**
A: 这是为了避免大量数据造成的信息过载，引导用户使用筛选功能进行精准分析。

---

## 更新日志

### 2025-10-21
- ✅ 新增作物转换关系筛选功能
- ✅ 优化地块列表交互（初始状态引导）
- ✅ 增加地块定位功能
- ✅ 清除筛选时地图自动缩放

### 2025-10-20
- ✅ 时序分析功能上线
- ✅ 地图可视化优化
- ✅ 图表分析完善
- ✅ PDF报告导出功能
- ✅ 交互优化更新
- ✅ 性能优化实施

---

**文档说明**：本文档整合了时序分析的所有功能说明、使用指南和优化更新。



