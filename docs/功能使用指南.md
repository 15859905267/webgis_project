# 功能使用指南

> **文档说明**：本文档整合了所有功能模块的使用说明，包括影像管理、数据筛选、地图显示等。

---

## 📋 目录

1. [影像数据管理](#影像数据管理)
2. [监测主控台](#监测主控台)
3. [作物类型筛选](#作物类型筛选)
4. [数据统计与可视化](#数据统计与可视化)
5. [后端服务说明](#后端服务说明)

---

## 1. 影像数据管理

### 📤 上传影像

#### 步骤1：打开上传对话框
```
影像数据管理 → 点击"上传影像"按钮
```

#### 步骤2：选择文件
```
点击上传区域 或 拖拽文件到上传区域
支持格式：.tif, .tiff, .img, .jp2
```

#### 步骤3：填写元数据
```
必填字段：
- 年份：2024
- 期次：第1期
- 作物类型：全部作物 / 棉花 / 小麦 等

选填字段：
- 区域：kle
- 传感器：vh / Sentinel-2 / Landsat-8
- 云量：0-100%
- 描述：影像说明文字
```

#### 步骤4：确认上传
```
如果文件名已存在：
  → 弹出警告对话框
  → 选择"覆盖并上传"或"取消上传"

上传成功：
  ✅ 成功上传 1 个文件
  ⚠️ 提示：建议优化TIF文件
```

---

### 🔍 查看影像列表

#### 表格视图
```
显示列：
- 影像ID：IMG001
- 缩略图：彩色占位图
- 影像名称：2024_kle_vh_kndvi.tif
- 年份：2024年
- 期次：第1期
- 作物类型：全部作物
- 传感器：vh
- 采集日期：2024-01-01
- 区域：kle
- 云量：25% (绿色/黄色/红色标签)
- 文件大小：2.69MB
- 状态：processed + ✅已优化
```

#### 缩略图视图
```
网格布局显示：
┌─────────┐ ┌─────────┐ ┌─────────┐
│ 缩略图  │ │ 缩略图  │ │ 缩略图  │
│ 文件名  │ │ 文件名  │ │ 文件名  │
│ 2.69MB  │ │ 71MB    │ │ 2.76MB  │
│ [操作]  │ │ [操作]  │ │ [操作]  │
└─────────┘ └─────────┘ └─────────┘
```

---

### 🔧 影像操作

#### 1. 优化TIF（未优化文件）
```
点击"⚙️ 优化TIF"按钮：

第一步：优化说明对话框
  → 显示优化内容和注意事项
  → 点击"开始优化"

第二步：操作指引对话框
  → 显示详细操作步骤
  → 复制命令行指令
  → 点击"我知道了"

第三步：执行优化（命令行）
  1. 打开 Anaconda Prompt（管理员）
  2. cd 项目目录
  3. optimize_tif.bat
  4. 等待完成
  5. 刷新页面

优化完成后：
  - 状态变为"已优化"
  - 文件大小显著减小
  - 不再显示"优化TIF"按钮
```

#### 2. 编辑影像信息
```
点击"编辑"按钮 → 弹出编辑对话框

可编辑字段：
  ✅ 年份
  ✅ 期次
  ✅ 作物类型
  ✅ 区域
  ✅ 传感器
  ✅ 采集日期
  ✅ 云量（带警告提示）
  ✅ 描述

不可编辑字段（灰色显示）：
  ❌ 影像ID
  ❌ 文件名
  ❌ 文件大小
  ❌ 上传时间

云量字段特殊提示：
  ⚠️ 云量数据通常从遥感影像元数据中自动提取，
  请谨慎修改

保存后：
  - 前端立即更新（但刷新后恢复，需要后端支持持久化）
```

#### 3. 预览影像
```
点击"预览"按钮 → 弹出预览对话框

显示内容：
- 影像图片（SVG占位图或实际TIF渲染）
- 影像详细信息：
  * 影像ID、文件名
  * 年份、期次、作物类型
  * 传感器、采集日期、区域
  * 云量（如果有）
  * 文件大小（显示原始+优化大小）
  * 状态（pending/processed + 优化标签）
  * 上传时间
  * 描述
```

#### 4. 删除影像
```
单个删除：
  点击"删除"按钮 → 确认对话框 → 删除

批量删除：
  1. 勾选多个影像
  2. 点击"批量删除"按钮
  3. 确认对话框
  4. 删除

注意：
  ⚠️ 删除操作会永久删除文件，无法恢复
  ⚠️ 纯前端项目，刷新后数据会恢复（需要后端支持）
```

---

### 🔎 筛选和搜索

#### 搜索功能
```
搜索框：输入影像名称或区域
  → 实时过滤列表
  → 支持模糊匹配
```

#### 高级筛选
```
筛选条件：
  - 时间范围：开始日期 至 结束日期
  - 传感器类型：全部 / Sentinel-2 / Landsat-8 等
  - 云量范围：滑块 0-100%

应用筛选：
  点击"筛选"按钮 → 列表更新

重置筛选：
  点击"重置"按钮 → 恢复默认
```

---

## 2. 监测主控台

### 🗺️ 地图显示

#### 底图切换
```
底图选择下拉框（地图左上角）：
  - 高德路网图（默认）
  - 高德影像图
  - 高德纯净图
  - 无底图

实时切换，无需刷新
```

#### 地图操作
```
缩放：
  - 鼠标滚轮
  - 点击"放大""缩小"按钮
  - 双击地图放大

平移：
  - 鼠标拖拽
  - 键盘方向键

缩放至：
  - 点击"缩放至"按钮
  - 自动缩放到当前激活图层的范围
```

---

### 🎯 影像筛选和加载

#### 步骤1：选择年份
```
年份期次：2024年（自动从数据中获取）
```

#### 步骤2：选择期次
```
第1期（根据年份动态加载可用期次）
```

#### 步骤3：选择影像名称（可选）
```
如果同一年份同一期次有多个影像：
  → 下拉框显示所有可用影像
  → 选择需要显示的影像

如果只有一个影像：
  → 自动选择
```

#### 步骤4：选择作物类型（多选）
```
默认：全部作物（显示所有）

可选择：
  ☑️ 裸地（咖啡色）
  ☑️ 棉花（白色）
  ☑️ 小麦（金黄色）
  ☑️ 玉米（橙色）
  ☑️ 番茄（番茄红）
  ☑️ 甜菜（粉红色）
  ☑️ 打瓜（绿色）
  ☑️ 辣椒（深红色）
  ☑️ 籽用葫芦（紫色）
  ☑️ 其它耕地（灰色）

支持：
  - 多选（Ctrl+点击）
  - 全选/全不选
  - 折叠标签（超过3个时）
```

#### 步骤5：点击查询
```
点击"查询"按钮：
  → 加载选中的影像到地图
  → 显示作物分类图层
  → 更新右侧统计图表
  → 更新KPI数据卡片

如果没有选择影像：
  ⚠️ 提示：请先选择影像名称
```

#### 重置
```
点击"重置"按钮：
  → 清空所有筛选条件
  → 隐藏地图图层
  → 恢复默认状态
```

---

### 🎨 作物分类图例

#### 图例显示
```
位置：地图左下角

显示时机：
  - 仅在选择影像并点击"查询"后显示
  - 未选择影像时不显示

内容：
  - 图例标题：作物分类图例
  - 图层开关：☑️ 作物分类 (2024)
  - 图例项：仅显示已选择的作物类型

折叠/展开：
  - 点击标题栏的向下箭头
  - 折叠后只显示标题栏
```

#### 动态更新
```
当改变作物类型选择时：
  → 图例自动更新（只显示选中的）
  → 地图图层自动更新（只显示选中的）
  → 未选中的作物类型显示为透明

示例：
  如果只选择了"棉花"和"小麦"：
    图例：只显示棉花（白色）和小麦（金黄色）
    地图：只渲染这两种作物，其他透明
```

---

## 3. 作物类型筛选

### 🎯 筛选逻辑

#### 单选模式（未实现）
```
选择"棉花" → 只显示棉花区域
选择"小麦" → 只显示小麦区域
```

#### 多选模式（已实现）✅
```
选择"棉花"+"小麦" → 同时显示两种作物
未选择的作物类型 → 渲染为透明色
```

#### 全选（默认）
```
不选择任何作物 或 选择全部
  → 显示所有作物类型
  → 图例显示所有10种作物
```

---

### 🎨 颜色映射

```javascript
作物类型颜色表：
0:  裸地       → #D2B48C (咖啡色)
1:  棉花       → #FFFFFF (白色)
2:  小麦       → #FFD700 (金黄色)
3:  玉米       → #FFA500 (橙色)
4:  番茄       → #FF6347 (番茄红)
5:  甜菜       → #FF1493 (粉红色)
6:  打瓜       → #00FF7F (绿色)
7:  辣椒       → #DC143C (深红色)
8:  籽用葫芦   → #9370DB (紫色)
9:  其它耕地   → #808080 (灰色)
255: NoData    → 透明
```

---

### 💻 前端实现

#### WebGL渲染样式
```javascript
const style = {
  color: [
    'case',
    // NoData - 完全透明
    ['==', ['band', 1], 255],
    [0, 0, 0, 0],
    
    // 裸地
    ['==', ['band', 1], 0],
    selectedCropTypes.includes('裸地') 
      ? [210, 180, 140, 1]  // 显示
      : [0, 0, 0, 0],        // 透明
    
    // 棉花
    ['==', ['band', 1], 1],
    selectedCropTypes.includes('棉花')
      ? [255, 255, 255, 1]
      : [0, 0, 0, 0],
    
    // ... 其他作物类型
    
    // 默认（未知值）- 透明
    [0, 0, 0, 0]
  ]
}
```

---

## 4. 数据统计与可视化

### 📊 KPI数据卡片

位置：页面顶部

```
┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│  📊 128,456  │ │  ✅ 92.8%    │ │  ⚠️ 245      │ │  📋 3,421    │
│ 总监测面积（亩）│ │  作物吻合率   │ │  差异地块数   │ │  地块总数     │
└──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘
```

数据来源：
- 从 `imageData.json` 的 `statistics` 字段读取
- 当前为模拟数据
- 选择影像并查询后自动更新

---

### 📈 作物类型分布（饼图）

位置：地图右侧

```
┌─────────────────────┐
│  作物类型分布        │
├─────────────────────┤
│                      │
│      [饼图]          │
│                      │
│  棉花  35.2%        │
│  小麦  18.6%        │
│  玉米  15.3%        │
│  ...               │
└─────────────────────┘
```

特性：
- ✅ 自动根据选中的作物类型过滤
- ✅ 支持图例滚动（超过10项时）
- ✅ 鼠标悬停显示详细信息
- ✅ 点击图例项隐藏/显示

动态更新：
```
如果只选择了"棉花"和"小麦"：
  → 饼图只显示这两种作物的占比
  → 百分比自动重新计算
```

---

### 📊 差异类型统计（柱状图）

位置：地图右侧（饼图下方）

```
┌─────────────────────┐
│  差异类型统计        │
├─────────────────────┤
│                      │
│  类型不符   ████  120│
│  撂荒未种   ███   52 │
│  非规划种植 ██    43 │
│  超范围种植 ██    30 │
│                      │
└─────────────────────┘
```

数据来源：当前为模拟数据

---

### 📈 近年监测趋势（折线图）

位置：页面底部

```
┌────────────────────────────────────────┐
│  近年监测趋势分析                       │
├────────────────────────────────────────┤
│                                         │
│      [折线图]                           │
│      显示2021-2024年的监测数据变化趋势  │
│                                         │
└────────────────────────────────────────┘
```

指标：
- 总监测面积
- 地块匹配率
- 差异地块数
- 可切换显示

---

## 5. 后端服务说明

### 🔧 数据存储

#### 当前方案：文件系统 + JSON

```
public/data/
├── 2024_kle_vh_kndvi.tif           ← 优化后的TIF
├── 2024_kle_vh_kndvi.original.tif  ← 原始备份
├── 2024_kle_vh_kndvi.backup.tif    ← 其他版本
└── imageData.json                  ← 元数据
```

**imageData.json 结构**：
```json
{
  "images": [
    {
      "id": "IMG001",
      "name": "2024_kle_vh_kndvi.tif",
      "year": "2024",
      "period": "1",
      "cropType": "all",
      "size": "2.69MB",
      "originalSize": "71.25MB",
      "optimizedSize": "2.69MB",
      "isOptimized": true,
      "status": "processed",
      "uploadTime": "2025-10-16T07:44:40.171Z",
      "statistics": {
        "totalArea": "128456",
        "matchRate": "92.8",
        "diffCount": "245",
        "plotCount": "3421",
        "cropDistribution": {
          "裸地": 12.5,
          "棉花": 35.2,
          "小麦": 18.6,
          // ...
        }
      }
    }
  ]
}
```

---

### 🚀 自动同步机制

后端 Express 服务会自动：

1. **启动时扫描**
   ```
   服务启动 → syncMetadata() → 扫描data目录
   → 读取所有TIF文件 → 更新imageData.json
   ```

2. **每次API调用时更新**
   ```
   GET /image/list → syncMetadata() → 返回最新数据
   ```

3. **自动计算文件大小**
   ```javascript
   const stats = fs.statSync(filePath)
   const fileSize = (stats.size / 1024 / 1024).toFixed(2) + 'MB'
   ```

4. **自动移除已删除的文件**
   ```javascript
   metadata.images = metadata.images.filter(
     img => tifFiles.includes(img.name)
   )
   ```

---

### 📡 API接口

#### 获取影像列表
```
GET /image/list

Response:
{
  "code": 200,
  "message": "获取成功",
  "data": [
    { /* 影像信息 */ }
  ]
}
```

#### 上传影像
```
POST /image/upload
Content-Type: multipart/form-data

FormData:
  - files: [File, File, ...]
  - year: "2024"
  - period: "1"
  - cropType: "all"
  - region: "kle"
  - sensor: "vh"
  - cloudCover: 25
  - description: "说明"

Response:
{
  "code": 200,
  "message": "上传成功",
  "data": { count: 1 }
}
```

#### 删除影像
```
DELETE /image/:id

Response:
{
  "code": 200,
  "message": "删除成功"
}
```

#### 批量删除
```
POST /image/batch-delete
Body: {
  "ids": ["IMG001", "IMG002"]
}

Response:
{
  "code": 200,
  "message": "批量删除成功",
  "data": { count: 2 }
}
```

---

### ⚙️ 配置说明

**后端端口**：8080

**环境变量**：
```bash
PORT=8080  # 可自定义端口
```

**数据目录**：
```javascript
const DATA_DIR = path.join(__dirname, '../../public/data')
const METADATA_FILE = path.join(DATA_DIR, 'imageData.json')
```

---

## 📚 快速参考

### 常用操作

| 操作 | 位置 | 快捷方式 |
|------|------|----------|
| 上传影像 | 影像数据管理 | - |
| 优化TIF | 影像列表 → 操作 | - |
| 编辑信息 | 影像列表 → 编辑 | - |
| 查看地图 | 监测主控台 | - |
| 筛选影像 | 监测主控台 → 查询栏 | - |
| 切换底图 | 地图 → 左上角下拉框 | - |
| 缩放地图 | 地图 → 缩放按钮 | 鼠标滚轮 |

### 快捷键（规划中）

| 功能 | 快捷键 |
|------|--------|
| 打开上传 | Ctrl + U |
| 搜索影像 | Ctrl + F |
| 刷新列表 | F5 |
| 缩放至 | Z |
| 切换底图 | M |

---

## 🔄 更新日志

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| v3.0 | 2025-10-16 | 整合所有功能文档 |
| v2.0 | 2025-10-16 | 添加作物类型多选 |
| v1.0 | 2025-10-15 | 初始版本 |

---

**文档维护者**：WebGIS开发团队  
**最后更新**：2025-10-16

