# 面积计算完整指南

> **综合文档** - 整合了面积计算方案、系数统一、实现说明等所有内容  
> **最后更新：** 2025-10-28

---

## 📋 目录

1. [面积计算方案总结](#面积计算方案总结)
2. [面积计算系数统一](#面积计算系数统一)
3. [技术实现](#技术实现)
4. [使用指南](#使用指南)
5. [常见问题](#常见问题)

---

## 面积计算方案总结

### 核心问题

不同格式文件的面积计算方式不同，需要统一方案：

| 文件类型 | 数据特征 | 计算方式 |
|---------|---------|---------|
| **TIF** | 栅格数据 | 基于像元数量 |
| **SHP/GeoJSON** | 矢量数据 | 基于几何图形 |
| **KMZ** | 矢量数据（压缩） | 基于GeoJSON中间文件 |

### 方案对比

#### 方案1：前端计算（JavaScript）
**工具：** turf.js

**优点：**
- 无需后端支持
- 实时计算
- 用户友好

**缺点：**
- 精度较低
- 不支持投影坐标系
- 大数据量性能差

#### 方案2：后端计算（Python）⭐ 推荐
**工具：** GeoPandas

**优点：**
- 精度高
- 支持所有坐标系
- 考虑地球曲率
- 性能好

**缺点：**
- 需要安装GeoPandas
- 需要后端调用

**最终选择：方案2（GeoPandas）**

---

## 面积计算系数统一

### 历史问题

之前代码中面积转换系数不统一：

```javascript
// ❌ 错误：多处使用不同系数
area_mu = area_m2 / 667      // 某些地方
area_mu = area_m2 / 666.67   // 另一些地方
area_mu = area_m2 / 666.6667 // 还有的地方
```

导致：
- 同一地块在不同页面显示面积不同
- 数据不一致，用户困惑

### 标准转换系数

**官方定义：** 1亩 = 666.666...平方米（2/3 * 1000）

**推荐使用：**
```javascript
const AREA_CONVERSION_FACTOR = 666.67  // 平方米转亩

// 使用方式
const area_mu = area_m2 / AREA_CONVERSION_FACTOR
```

### 统一修改

#### 后端统一

**文件：** `server/routes/analysis.js`

```javascript
// 定义全局常量（文件顶部）
const AREA_CONVERSION_FACTOR = 666.67

// Python脚本中使用
const pythonScript = `
AREA_CONVERSION_FACTOR = 666.67

# 计算面积（亩）
area_mu = area_m2 / AREA_CONVERSION_FACTOR
`

// JavaScript中使用
const areaMu = Number((areaM2 / AREA_CONVERSION_FACTOR).toFixed(2))
```

#### 前端统一

**文件：** `src/views/Dashboard/index.vue`

```javascript
// 定义常量
const AREA_CONVERSION_FACTOR = 666.67

// TIF面积计算
const totalAreaMu = (totalAreaM2 / AREA_CONVERSION_FACTOR).toFixed(2)

// SHP/GeoJSON面积计算
stats.totalArea = (totalAreaM2 / AREA_CONVERSION_FACTOR).toFixed(0)

// KMZ面积统计
const totalAreaMu = areas.reduce((sum, a) => sum + (a.area_m2 || 0), 0) / AREA_CONVERSION_FACTOR
```

### 修改位置汇总

| 文件 | 位置 | 修改内容 |
|------|------|----------|
| `server/routes/analysis.js` | 第12行 | 定义全局常量 |
| `server/routes/analysis.js` | 第380-400行 | Python脚本中使用 |
| `server/routes/analysis.js` | 第580行 | GET返回时使用 |
| `src/views/Dashboard/index.vue` | 第58行 | 定义常量 |
| `src/views/Dashboard/index.vue` | 第1320-1340行 | TIF分析中使用 |
| `src/views/Dashboard/index.vue` | 第1580-1600行 | KMZ统计中使用 |

---

## 技术实现

### TIF栅格数据面积计算

```javascript
async function analyzeTifFile(filePath) {
  // 1. 使用GDAL读取TIF文件
  const gdalinfo = await execGdal(`gdalinfo -json "${filePath}"`)
  const info = JSON.parse(gdalinfo)
  
  // 2. 获取像元分辨率
  const geoTransform = info.geoTransform
  const pixelWidth = Math.abs(geoTransform[1])   // 像元宽度（米）
  const pixelHeight = Math.abs(geoTransform[5])  // 像元高度（米）
  const pixelArea = pixelWidth * pixelHeight     // 单个像元面积（平方米）
  
  // 3. 统计各类作物的像元数量
  const counts = {
    0: 0,  // 裸地
    1: 0,  // 棉花
    2: 0,  // 小麦
    // ...
  }
  
  // 使用gdalinfo统计或numpy读取
  // counts = await countPixels(filePath)
  
  // 4. 计算总面积
  const totalPixels = Object.values(counts).reduce((sum, count) => sum + count, 0)
  const totalAreaM2 = totalPixels * pixelArea
  const totalAreaMu = totalAreaM2 / 666.67
  
  // 5. 计算各作物面积占比
  const cropDistribution = {}
  Object.entries(counts).forEach(([cropCode, count]) => {
    const areaM2 = count * pixelArea
    const areaMu = areaM2 / 666.67
    const percentage = (count / totalPixels * 100).toFixed(2)
    
    cropDistribution[cropNames[cropCode]] = {
      area_m2: areaM2.toFixed(2),
      area_mu: areaMu.toFixed(2),
      percentage: percentage
    }
  })
  
  return {
    totalArea: totalAreaMu.toFixed(0),
    plotCount: totalPixels.toString(),  // 有效像元数
    cropDistribution
  }
}
```

### SHP/GeoJSON矢量数据面积计算

```python
# Python (GeoPandas)
import geopandas as gpd
from shapely.ops import transform
import pyproj

# 读取SHP文件
gdf = gpd.read_file('path/to/file.shp')

# 转换为WGS84（如果需要）
if gdf.crs.to_epsg() != 4326:
    gdf = gdf.to_crs(epsg=4326)

# 创建投影转换器（WGS84 -> Web Mercator用于面积计算）
project = pyproj.Transformer.from_crs(
    'EPSG:4326',  # WGS84
    'EPSG:3857',  # Web Mercator
    always_xy=True
).transform

# 计算面积
areas = []
for idx, row in gdf.iterrows():
    # 将几何投影到Web Mercator
    projected_geom = transform(project, row.geometry)
    
    # 计算面积（平方米）
    area_m2 = projected_geom.area
    
    # 转换为亩
    area_mu = area_m2 / 666.67
    
    areas.append({
        'index': idx,
        'area_m2': round(area_m2, 2),
        'area_mu': round(area_mu, 2)
    })

# 输出JSON
import json
print(json.dumps(areas))
```

### KMZ面积获取

```javascript
// KMZ从对应的GeoJSON文件读取面积数据
async function getKmzAreas(kmzFilename, relativePath) {
  // 1. 构造对应的GeoJSON文件路径
  const basename = path.basename(kmzFilename, '.kmz')
  const geojsonPath = path.join(GEOJSON_DIR, `${basename}.geojson`)
  
  // 2. 读取GeoJSON文件
  if (fs.existsSync(geojsonPath)) {
    const geojsonData = JSON.parse(fs.readFileSync(geojsonPath, 'utf-8'))
    
    // 3. 提取面积数据
    const areas = geojsonData.features.map(feature => ({
      area_m2: feature.properties.area_m2 || 0,
      area_mu: feature.properties.area_mu || 0
    }))
    
    // 4. 计算总面积
    const totalAreaM2 = areas.reduce((sum, a) => sum + a.area_m2, 0)
    const totalAreaMu = totalAreaM2 / 666.67
    
    return {
      areas,
      totalAreaM2,
      totalAreaMu,
      source: 'GeoJSON文件'
    }
  } else {
    throw new Error('对应的GeoJSON文件不存在')
  }
}
```

---

## 使用指南

### 查看面积统计

#### TIF影像
1. 在主控台选择TIF影像
2. 点击"查询"
3. 查看右侧统计卡片的"总监测面积"

#### SHP/GeoJSON
1. 上传SHP文件（ZIP格式）
2. 在主控台选择该文件
3. 自动显示总面积和地块数量

#### KMZ文件
1. SHP转KMZ时自动计算面积
2. 在主控台加载KMZ
3. 自动显示总面积统计

### 精度说明

| 数据类型 | 精度 | 说明 |
|---------|------|------|
| TIF | ±1-5% | 取决于像元分辨率 |
| SHP/GeoJSON | ±0.1% | GeoPandas高精度计算 |
| KMZ | ±0.1% | 来自GeoJSON数据 |

### 单位转换

```javascript
// 标准转换公式
1 亩 = 666.67 平方米
1 公顷 = 15 亩 = 10000 平方米
1 平方公里 = 1500 亩 = 1000000 平方米

// 代码中使用
const CONVERSION_FACTORS = {
  MU_TO_M2: 666.67,        // 亩转平方米
  HECTARE_TO_MU: 15,       // 公顷转亩
  KM2_TO_MU: 1500,         // 平方公里转亩
  M2_TO_MU: 1/666.67       // 平方米转亩
}
```

---

## 常见问题

### Q1: 为什么同一地块在不同页面面积不同？
**A:** 检查是否使用了统一的转换系数666.67。历史版本可能使用了不同系数。

### Q2: TIF面积和SHP面积哪个更准确？
**A:** SHP/GeoJSON更准确，因为是基于实际几何图形计算。TIF是基于像元估算。

### Q3: 如何提高TIF面积计算精度？
**A:** 
- 使用更高分辨率的影像
- 确保分类准确
- 使用更精细的像元分类

### Q4: GeoPandas计算面积是否考虑地球曲率？
**A:** 是的。通过投影到Web Mercator (EPSG:3857)，考虑了地球椭球体特征。

### Q5: 面积单位可以自定义吗？
**A:** 可以。修改`AREA_CONVERSION_FACTOR`常量即可：
```javascript
// 平方米（国际单位）
const AREA_CONVERSION_FACTOR = 1

// 公顷
const AREA_CONVERSION_FACTOR = 10000

// 平方公里
const AREA_CONVERSION_FACTOR = 1000000
```

### Q6: 为什么KMZ面积读取速度快？
**A:** KMZ转换时已经预计算并保存在GeoJSON中，加载时直接读取，无需重新计算。

---

## 依赖要求

### Python环境
```bash
# 安装GeoPandas（必需）
conda install geopandas

# 依赖
# - GDAL
# - Shapely
# - pyproj
```

### Node.js依赖
```bash
# package.json
{
  "dependencies": {
    "turf": "^6.5.0",  # 可选，前端简单计算
  }
}
```

---

## 最佳实践

### 1. 统一使用常量
```javascript
// ✅ 推荐
const AREA_CONVERSION_FACTOR = 666.67
const area_mu = area_m2 / AREA_CONVERSION_FACTOR

// ❌ 不推荐
const area_mu = area_m2 / 667  // 硬编码
```

### 2. 保留适当精度
```javascript
// 总面积：保留整数
const totalArea = totalAreaMu.toFixed(0)

// 单个地块：保留2位小数
const plotArea = areaMu.toFixed(2)

// 百分比：保留2位小数
const percentage = (value * 100).toFixed(2)
```

### 3. 数据验证
```javascript
// 检查面积是否合理
if (area_mu < 0 || area_mu > 1000000) {
  console.warn('面积数据异常:', area_mu)
}

// 检查是否为数字
if (isNaN(area_mu)) {
  console.error('面积计算失败')
}
```

### 4. 性能优化
```javascript
// 大数据量时使用批处理
const batchSize = 1000
for (let i = 0; i < features.length; i += batchSize) {
  const batch = features.slice(i, i + batchSize)
  await calculateAreas(batch)
}
```

---

## 相关文件

### 后端
- `server/routes/analysis.js` - 主要面积计算逻辑
- `server/scripts/calculate_area.py` - Python面积计算脚本

### 前端
- `src/views/Dashboard/index.vue` - 面积统计显示
- `src/utils/format.js` - 数值格式化工具

---

## 更新日志

**2025-10-28**
- ✅ 整合所有面积计算相关文档
- ✅ 统一说明和示例

**2025-10-27**
- ✅ 统一面积转换系数为666.67
- ✅ 修复多处系数不一致问题
- ✅ 添加全局常量定义

**2025-10-22**
- ✅ 实现GeoPandas面积计算
- ✅ KMZ面积自动化
- ✅ TIF面积统计优化

---

**文档说明：** 本文档整合了所有面积计算相关文档的内容，提供统一参考。
