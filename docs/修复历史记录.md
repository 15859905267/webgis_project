# 修复历史记录

本文档记录了项目开发过程中所有重要的问题修复和功能更新。

---

## 📅 2025-10-23 - 任务管理界面优化

### 新增功能
1. **任务信息对话框**
   - 将任务信息表单改为对话框形式
   - 支持批量任务独立信息填写
   - "应用到所有"选项，自动为任务名称编号

2. **地图高度优化**
   - Dashboard地图高度改为自适应：`calc(100vh - 280px)`
   - 时序变化地图高度增加到 620px
   - 工具栏padding优化，减少空间占用

3. **地块详情弹窗拖拽**
   - 改用 `position: fixed` 定位
   - 支持拖拽到屏幕任意位置

### 交互优化
- 取消按钮不再弹出二次确认
- 关闭对话框时保留已填写信息
- 组件卸载时才清空数据

---

## 📅 2025-10-22 - 饼图显示和统计计算修复

### ✅ 问题1：饼图只显示部分数据

**问题描述**：
- 饼图只显示5个部分，占比小的作物（如玉米0.33%）不显示
- 控制台有完整统计数据，但图表未完整渲染

**根本原因**：
1. `minAngle` 设置导致小扇区被隐藏
2. `setOption` 使用不完整配置，缺少 `type`、`radius` 等关键属性

**解决方案**：
```javascript
// 完整配置饼图
const option = {
  color: cropLegend.map(item => item.color),  // 使用预定义颜色
  tooltip: {
    trigger: 'item',
    formatter: '{b}: {c}%'
  },
  legend: {
    type: 'plain',
    orient: 'horizontal',
    textStyle: { fontSize: 11 },
    itemWidth: 12,
    itemHeight: 12
  },
  series: [{
    type: 'pie',
    radius: ['35%', '60%'],
    center: ['50%', '42%'],
    minAngle: 0,  // 🔧 关键：允许显示所有数据
    itemStyle: {
      borderRadius: 10,
      borderColor: '#fff',
      borderWidth: 2
    },
    data: cropData
  }]
}
cropChart.setOption(option, true)  // true = notMerge，完全替换
```

**修改文件**：`src/views/Dashboard/index.vue` (2211-2267行)

### ✅ 问题2：地块总数计算不准确

**问题描述**：
- TIF栅格数据显示的"地块总数"实际是估算值（总面积÷50）
- 栅格数据无法准确计算地块数

**解决方案**：
```javascript
// analyzeTifFile函数返回值
return {
  totalArea: totalArea.toFixed(0),
  plotCount: totalPixels.toString(),  // 改为显示有效像元总数
  pixelCount: totalPixels,
  // ...
}
```

**UI标签修改**：
```vue
<div class="stat-label">
  {{ dataSource === 'image' ? '有效像元数' : '地块总数' }}
</div>
<div class="stat-value">
  {{ kpiData.plotCount }}
  <span class="stat-unit">
    {{ dataSource === 'image' ? '个' : '块' }}
  </span>
</div>
```

**修改文件**：`src/views/Dashboard/index.vue`

### ✅ 问题3：KMZ文件路径错误

**问题**：
```
Failed to parse URL from http://localhost:3000planting_situation\YZC
```

**原因**：
1. 缺少 `/data/data_kmz/` 前缀
2. Windows反斜杠 `\` 未转换为URL正斜杠 `/`

**修复**：
```javascript
// 修复前
const filePath = `http://localhost:3000${file.relativePath}`

// 修复后
const normalizedPath = file.relativePath.replace(/\\/g, '/')
const filePath = `http://localhost:3000/data/data_kmz/${normalizedPath}/${file.name}`
```

**修改文件**：`src/views/Dashboard/index.vue` (944-952行)

### ✅ 问题4：统计卡片样式未更新

**问题**：CSS类名错误 `-tistatstle`（应为 `stats-title`）

**修复**：
```vue
<!-- 修复前 -->
<span class="-tistatstle">

<!-- 修复后 -->
<span class="stats-title">
```

**修改文件**：`src/views/Dashboard/index.vue` (378行)

### ✅ 问题5：KMZ种植情况解析

**需求**：从KMZ的description字段（HTML格式）解析种植情况

**解析逻辑**：
```javascript
// description示例：
// <table><tr><td>种植情况</td><td>已种植</td></tr></table>

const plantedMatch = desc.match(/种植情况.*?<td>([^<]+)<\/td>/i) ||
                    desc.match(/<td>(已种植|未种植)<\/td>/i) ||
                    desc.match(/>(已种植|未种植)</i)

if (plantedMatch && plantedMatch[1]) {
  status = plantedMatch[1].trim()
} else if (props.name === '0') {
  status = '未种植'
} else if (props.name === '1') {
  status = '已种植'
}
```

**修改文件**：`src/views/Dashboard/index.vue` (updateKmzStatistics函数)

### ✅ 问题6：右上角按钮样式统一

**修复内容**：统一饼图卡片和统计卡片的右上角按钮样式

```scss
.file-switch-controls {
  background: rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(10px);
  
  .file-index {
    color: white;
    font-weight: 600;
  }
  
  :deep(.el-button) {
    background: rgba(255, 255, 255, 0.15);
    color: white;
    
    &:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.3);
    }
  }
}
```

**效果**：白色半透明背景 + 毛玻璃效果，适配紫色表头

---

## 📅 2025-10-22 - SHP文件管理功能

### 新增功能
将识别结果（SHP格式）存放在子文件夹中，支持递归扫描和管理。

### 后端修改

**文件**：`server/routes/analysis.js`

**递归扫描逻辑**：
```javascript
const scanShpDir = (dirPath, relativePath = '') => {
  const items = fs.readdirSync(dirPath)
  
  items.forEach((item) => {
    const itemPath = path.join(dirPath, item)
    const stats = fs.statSync(itemPath)
    
    if (stats.isDirectory()) {
      // 递归扫描子目录
      scanShpDir(itemPath, path.join(relativePath, item))
    } else if (item.endsWith('.shp')) {
      // 处理SHP文件
      results.push({
        id: `shp_${basename}_${stats.mtimeMs}`,
        name: item,
        type: 'SHP',
        relativePath: relativePath,
        regionCode: extractRegionCode(relativePath),
        // ...
      })
    }
  })
}
```

### 使用方法

**文件结构**：
```
public/data/data_shp/
├── YZC/
│   ├── result.shp
│   ├── result.shx
│   ├── result.dbf
│   ├── result.prj
│   └── ...
├── BTH/
│   └── ...
```

**访问路径**：
- 影像数据管理 → 结果队列 → 识别结果
- 支持格式筛选（SHP）和区域筛选

---

## 📅 更早期修复记录

### TIF影像优化
- 实现自动优化脚本 `optimize_tif.bat`
- 支持坐标系转换（EPSG:4326 → EPSG:3857）
- 压缩优化（LZW压缩）

### 时序分析功能
- 多期数据对比
- 作物轮转关系分析
- 变化轨迹追踪

### PDF报告生成
- 自动生成分析报告
- 包含地图、统计图表
- 保存到服务器和本地

### 分析结果持久化
- JSON格式存储
- 支持重新加载
- 元数据管理

---

## 🔍 调试技巧

### 饼图问题诊断
```javascript
// 控制台检查
const chartDom = document.getElementById('crop-chart')
console.log('图表容器高度:', chartDom?.offsetHeight)
console.log('ECharts实例:', echarts.getInstanceByDom(chartDom))
console.log('饼图数据:', cropData)
```

### KMZ加载问题
```javascript
// 检查文件路径
console.log('relativePath:', file.relativePath)
console.log('完整路径:', filePath)

// 检查features
console.log('features数量:', features.length)
console.log('第一个feature:', features[0].getProperties())
```

### 统计数据验证
```javascript
// 检查TIF分析结果
console.log('总面积:', totalArea.toFixed(0))
console.log('有效像元:', totalPixels)
console.log('作物分布:', cropDistribution)
console.log('像元统计:', counts)
```

---

## 📝 文档更新记录

- **2025-10-23**：任务管理界面优化
- **2025-10-22**：饼图修复、SHP文件管理、KMZ解析
- **2025-10-21**：时序分析功能完善
- **2025-10-20**：PDF报告生成功能

---

**说明**：本文档持续更新，记录所有重要的问题修复和功能变更。

