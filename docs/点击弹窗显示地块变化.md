# 点击弹窗显示地块变化更新说明

## 📅 更新日期
2025年10月20日

## 🎯 本次优化内容

### 功能变更：从悬停提示改为点击弹窗

**用户需求**：不需要鼠标悬停就显示地块信息，而是点击地块后弹出一个对话框显示详细的作物变化情况。

---

## ✅ 已完成的修改

### 1. 移除鼠标悬停 Tooltip 功能

**移除的内容**：
- 删除 `hoveredFeature`、`tooltipVisible`、`tooltipRef`、`tooltipPosition` 等响应式变量
- 删除 `tooltipStyle` 计算属性
- 删除 `handleMapHover` 事件处理函数
- 移除 `map.on('pointermove', handleMapHover)` 事件监听器
- 删除模板中的 tooltip DOM 元素
- 删除 `.map-tooltip` 相关样式

**效果**：鼠标悬停在地块上不再显示任何提示信息。

---

### 2. 添加点击弹出对话框功能

**新增内容**：

#### 导入依赖
```javascript
import { ElMessageBox, ElTag } from 'element-plus'
import { h } from 'vue'  // Vue 3 的 h 函数用于创建 VNode
```

#### 核心函数：`showPlotChangeDialog(feature)`

当用户点击地块时，会调用此函数弹出 Element Plus 的 MessageBox 对话框，显示以下信息：

##### **地块基本信息**
- 地块名称（粗体显示）
- 地块 ID
- 地块面积（公顷）

##### **作物变化信息**
- **起始作物**：绿色标签（success）
- **结束作物**：橙色标签（warning）
- **变化次数**：
  - 0次：绿色（success）
  - 1次：黄色（warning）
  - 2次：红色（danger）
  - 3+次：蓝色（info）

##### **历史变化时间线**（如果有数据）
- 按时间顺序显示每个时间点的作物类型
- 每条记录包含时间和作物名称
- 使用浅灰色背景块区分每条记录

---

## 💻 技术实现

### 对话框构建（使用 h 函数）

```javascript
const showPlotChangeDialog = (feature) => {
  const props_data = feature.properties
  const plotName = props_data.plotName || props_data.name || '未命名地块'
  const changeCount = props_data.changeCount || 0
  const startCrop = props_data.startCrop || '未知'
  const endCrop = props_data.endCrop || '未知'
  const area = props_data.area ? props_data.area.toFixed(2) : '未知'
  const timeline = props_data.timeline || []
  
  // 使用 h 函数创建 VNode（支持 Element Plus 组件）
  const messageContent = h('div', { style: 'line-height: 1.8' }, [
    // ... 地块信息
    // ... 作物变化
    // ... 历史时间线
  ])
  
  ElMessageBox({
    title: '📍 地块详情',
    message: messageContent,
    confirmButtonText: '关闭',
    type: 'info',
    customClass: 'plot-change-dialog'
  })
}
```

### 点击事件流程

```javascript
const handleMapClick = (event) => {
  const feature = map.forEachFeatureAtPixel(event.pixel, (feature) => feature)
  
  if (feature) {
    // 1. 获取 feature ID
    const featureId = properties.id || properties.Id
    
    // 2. 查找完整的 feature 数据
    const fullFeature = props.data.features.find(...)
    
    // 3. 设置选中状态（高亮显示）
    selectedFeature.value = fullFeature
    selectedFeatureId.value = featureId
    
    // 4. 弹出对话框 ✨
    showPlotChangeDialog(fullFeature)
    
    // 5. 更新地图样式
    vectorLayer.changed()
  } else {
    // 点击空白处取消选中
    selectedFeature.value = null
    selectedFeatureId.value = null
    vectorLayer?.changed()
  }
}
```

---

## 🎨 对话框样式

### 对话框特点
- **标题**：📍 地块详情
- **布局**：清晰的分区（地块信息、作物变化、历史时间线）
- **颜色**：
  - 标题和字段名：灰色（#909399）
  - 数据值：深色（#303133, #606266）
  - 标签：根据类型使用不同颜色
- **交互**：
  - 确认按钮：关闭
  - 可滚动内容（最大高度 500px）

### 自定义样式
```scss
:deep(.plot-change-dialog) {
  .el-message-box__message {
    max-height: 500px;
    overflow-y: auto;
  }
}
```

---

## 📊 数据结构

### Feature Properties 字段
```javascript
{
  id: string | number,          // 地块ID
  plotName: string,             // 地块名称
  area: number,                 // 面积（公顷）
  changeCount: number,          // 变化次数
  startCrop: string,            // 起始作物
  endCrop: string,              // 结束作物
  timeline: Array<{             // 历史时间线
    time: string,               // 时间点
    crop: string                // 作物类型
  }>
}
```

---

## 🎯 用户体验对比

### 优化前（悬停 Tooltip）
- ❌ 鼠标一移动到地块就显示，可能干扰浏览
- ❌ 信息量有限，只能显示简要信息
- ❌ Tooltip 位置可能遮挡其他内容
- ✅ 快速预览信息

### 优化后（点击弹窗）
- ✅ 主动操作，不干扰浏览体验
- ✅ 对话框可以显示更详细的信息
- ✅ 支持滚动，信息量不受限制
- ✅ 布局更清晰，阅读体验更好
- ✅ 点击空白处或关闭按钮即可退出
- ✅ 选中的地块会高亮显示（蓝色边框加粗）

---

## 🔍 测试建议

### 基本功能测试
1. **点击地块**：
   - 确认对话框正确弹出
   - 确认地块高亮显示（蓝色加粗边框）
   - 确认对话框信息准确（地块名、面积、作物等）

2. **对话框内容**：
   - 确认所有字段正确显示
   - 确认标签颜色符合变化次数规则
   - 确认历史时间线正确展示

3. **关闭对话框**：
   - 点击"关闭"按钮
   - 确认对话框消失
   - 确认地块仍保持高亮状态

4. **点击空白处**：
   - 确认取消地块高亮
   - 确认不弹出对话框

### 边界情况测试
1. **缺失数据**：
   - 没有地块名称 → 显示"未命名地块"
   - 没有面积 → 显示"未知"
   - 没有时间线 → 不显示时间线部分

2. **长内容**：
   - 地块名称很长
   - 时间线条目很多 → 确认滚动条正常

3. **快速点击**：
   - 连续点击多个地块
   - 确认每次都弹出新对话框

---

## 📂 涉及文件

### 修改的文件
- **`src/views/ResultCompare/components/TemporalChangeMap.vue`**
  - 导入：添加 `ElMessageBox`、`ElTag`、`h`
  - 移除：所有 tooltip 相关的代码
  - 新增：`showPlotChangeDialog` 函数
  - 修改：`handleMapClick` 调用弹窗函数
  - 样式：添加 `.plot-change-dialog` 自定义样式

---

## 🚀 后续可优化方向

### 功能增强
1. **更多信息**：
   - 显示地块的土壤类型
   - 显示灌溉方式
   - 显示产量数据

2. **数据可视化**：
   - 在对话框中嵌入小型图表（作物变化趋势）
   - 变化次数的环形进度图

3. **操作按钮**：
   - 添加"导出该地块数据"按钮
   - 添加"查看相似地块"按钮
   - 添加"缩放至该地块"按钮

### 交互优化
1. **键盘支持**：
   - ESC 键关闭对话框
   - 方向键在地块间切换

2. **历史记录**：
   - 记录最近查看的地块
   - 快速返回上一个查看的地块

3. **对比功能**：
   - 支持同时选择多个地块对比
   - 对比表格或并列显示

### 性能优化
1. **懒加载**：
   - 时间线数据按需加载
   - 大量地块时使用虚拟列表

2. **缓存**：
   - 缓存已查看的地块数据
   - 减少重复计算

---

## 📝 注意事项

1. **Vue 3 h 函数**：
   - 使用 `h()` 创建 VNode 可以在 MessageBox 中渲染 Element Plus 组件
   - 避免使用 `dangerouslyUseHTMLString`，提高安全性

2. **数据兼容性**：
   - 兼容 `id` 和 `Id` 字段（大小写）
   - 所有字段都有默认值，避免显示 undefined

3. **样式隔离**：
   - 使用 `customClass` 自定义对话框样式
   - 不影响其他 MessageBox 实例

4. **性能考虑**：
   - `h()` 函数动态创建 VNode，性能开销较小
   - 对话框内容较多时自动出现滚动条



