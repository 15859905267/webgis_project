# 项目更新日志

本文档记录了项目的所有功能更新和问题修复。

---

## 2025-10-22 更新汇总

### 功能实现

#### 1. SHP文件夹上传功能
**实现日期：** 2025-10-22

**功能描述：**
- 支持将SHP文件夹打包成ZIP后上传
- 自动解压到 `public/data/data_shp/文件夹名/`
- 下载时自动打包成ZIP
- 删除时删除整个文件夹
- 上传时自动生成元数据JSON文件（即使不填写表单）

**涉及文件：**
- `src/views/ImageManagement/index.vue` - 前端上传界面
- `server/routes/analysis.js` - 后端处理逻辑

**使用方法：**
1. 将SHP文件夹打包成ZIP（文件名作为文件夹名）
2. 上传ZIP文件（可选填写元数据）
3. 系统自动解压并生成元数据文件

---

#### 2. KMZ加载和多文件统计功能
**实现日期：** 2025-10-22

**功能描述：**
- 支持KMZ文件的正确加载和显示
- 支持多个识别结果文件的同时显示
- 支持在不同文件间切换查看统计信息
- 自动计算面积和地块数量
- 生成种植情况饼图

**涉及文件：**
- `src/views/Dashboard/index.vue`

**技术要点：**
- 使用OpenLayers的KML格式读取器
- 实现图层管理和切换机制
- 面积计算：平方米 ÷ 666.67 = 亩

---

#### 3. 元数据存储系统
**实现日期：** 2025-10-22

**功能描述：**
- 影像数据（TIF）：统一存储在 `imageData.json`
- 识别结果（SHP/GeoJSON/KMZ）：每个文件对应独立的JSON元数据文件
- 上传时自动生成元数据（包含创建时间、上传时间）
- 编辑时保留原创建时间，更新修改时间
- 支持年份、期次、区域、识别类型等信息

**元数据文件位置：**
- SHP：`data_shp/文件夹名/文件名.json`
- GeoJSON：`data_geojson/文件名.json`
- KMZ：`data_kmz/路径/文件名.json`

**时间字段说明：**
- `createdAt`：创建时间（不会改变）
- `uploadTime`：上传时间
- `updatedAt`：最后更新时间

**时间格式：**
- 存储格式：ISO 8601 UTC时间（如：`2025-10-22T15:14:21.683Z`）
- 显示格式：本地时间（如：`2025/10/22 23:14:21`，东八区+8小时）

---

### 问题修复

#### 1. SHP子文件夹支持修复
**修复日期：** 2025-10-22

**问题描述：**
监测主控台选择子文件夹中的SHP文件时报404错误

**根本原因：**
后端只在根目录查找SHP文件，不支持子文件夹

**解决方案：**
- 实现递归查找函数 `findShpFile`
- 修改convert-to-geojson接口，支持相对路径参数
- 修改删除和下载接口，支持递归查找

**涉及文件：**
- `server/routes/analysis.js`
- `src/views/Dashboard/index.vue`

---

#### 2. SHP投影坐标异常修复
**修复日期：** 2025-10-22

**问题描述：**
- 地块总数显示正常，但总检测面积显示NaN
- 地图无法显示图层

**根本原因：**
- 原始SHP投影是EPSG:3857
- 前端只设置了 `featureProjection`，未设置 `dataProjection`
- OpenLayers默认将GeoJSON当作EPSG:4326处理，导致二次投影错误

**解决方案：**
```javascript
// 修复前：
const features = new GeoJSON().readFeatures(geojsonData, {
  featureProjection: 'EPSG:3857'
})

// 修复后：
const features = new GeoJSON().readFeatures(geojsonData, {
  dataProjection: 'EPSG:3857',    // 数据本身的坐标系
  featureProjection: 'EPSG:3857'  // 地图的坐标系
})
```

**投影知识点：**
- EPSG:4326 - WGS84地理坐标系（经纬度，单位：度）
- EPSG:3857 - Web Mercator投影坐标系（米制，单位：米）

---

#### 3. 饼图显示问题修复
**修复日期：** 2025-10-22

**问题描述：**
饼图只显示5个扇区，但实际有9-10种作物类型

**根本原因：**
没有为每个作物类型指定颜色，ECharts使用默认的5-6种颜色循环，多个作物使用了相同颜色

**解决方案：**
```javascript
// 方案1：为每个数据项指定颜色
const cropData = Object.entries(stats.cropDistribution).map(([name, value]) => {
  const cropInfo = cropLegend.find(c => c.label === name)
  return {
    value: Number(value),
    name: name,
    itemStyle: {
      color: cropInfo ? cropInfo.color : '#999999'
    }
  }
})

// 方案2：全局设置颜色数组
const option = {
  color: cropLegend.map(item => item.color),
  series: [{ type: 'pie', data: cropData }]
}
```

**其他修复：**
- 清理legend配置重复（type设置了两次）
- 移除minAngle限制
- 使用notMerge参数确保完全替换配置

---

#### 4. 创建时间显示错误修复
**修复日期：** 2025-10-22

**问题描述：**
识别结果列表中的创建时间不准确，不是用户上传时间或任务完成时间

**根本原因：**
- 上传时没有保存创建时间到元数据
- 后端扫描时使用文件修改时间作为创建时间

**解决方案：**

1. **上传时保存时间戳：**
```javascript
// 上传ZIP时自动生成元数据
const completeMetadata = {
  ...userMetadata,
  uploadTime: new Date().toISOString(),
  createdAt: new Date().toISOString()
}
fs.writeFileSync(metadataPath, JSON.stringify(completeMetadata, null, 2))
```

2. **读取时优先使用元数据时间：**
```javascript
// 优先级：createdAt > uploadTime > updatedAt > 文件修改时间
if (savedMetadata.createdAt) {
  createTime = new Date(savedMetadata.createdAt).toLocaleString('zh-CN')
} else if (savedMetadata.uploadTime) {
  createTime = new Date(savedMetadata.uploadTime).toLocaleString('zh-CN')
} else if (savedMetadata.updatedAt) {
  createTime = new Date(savedMetadata.updatedAt).toLocaleString('zh-CN')
} else {
  createTime = stats.mtime.toLocaleString('zh-CN')  // fallback
}
```

3. **编辑时保留原创建时间：**
```javascript
// 读取已有元数据
let existingMetadata = {}
if (fs.existsSync(metadataPath)) {
  existingMetadata = JSON.parse(fs.readFileSync(metadataPath, 'utf-8'))
}

// 合并时保留createdAt和uploadTime
const completeMetadata = {
  ...metadata,
  createdAt: existingMetadata.createdAt || metadata.createdAt || new Date().toISOString(),
  uploadTime: existingMetadata.uploadTime || metadata.uploadTime,
  updatedAt: new Date().toISOString()
}
```

---

#### 5. ZIP解压双层嵌套问题修复
**修复日期：** 2025-10-22

**问题描述：**
上传的ZIP文件解压后出现双层嵌套：
`data_shp/shp_2024_kle_vh_kndvi/shp_2024_kle_vh_kndvi/文件...`

**根本原因：**
用户打包ZIP时，直接压缩了文件夹，导致ZIP内部有一个根文件夹

**解决方案：**
```javascript
// 先解压到临时目录
const tempDir = path.join(SHP_DIR, `_temp_${basename}_${Date.now()}`)
zip.extractAllTo(tempDir, true)

// 检查临时目录内容
const tempContents = fs.readdirSync(tempDir)

// 如果只有一个文件夹，提取其内容
if (tempContents.length === 1) {
  const singleItem = tempContents[0]
  const singleItemPath = path.join(tempDir, singleItem)
  const stats = fs.statSync(singleItemPath)
  
  if (stats.isDirectory()) {
    // 将这个文件夹重命名为目标文件夹
    fs.renameSync(singleItemPath, targetDir)
    // 删除临时目录
    fs.rmSync(tempDir, { recursive: true, force: true })
  } else {
    fs.renameSync(tempDir, targetDir)
  }
} else {
  // 多个文件/文件夹，直接使用临时目录
  fs.renameSync(tempDir, targetDir)
}
```

---

#### 6. 监测主控台统计信息显示问题
**修复日期：** 2025-10-22

**问题描述：**
- 统计信息显示假数据（硬编码的初始值）
- TIF影像查询后统计信息没有显示
- KMZ数据一直显示"正在加载"

**解决方案：**

1. **统计信息初始化为0：**
```javascript
const kpiData = ref({
  totalArea: '0',
  matchRate: '0',
  diffCount: '0',
  plotCount: '0'
})
```

2. **TIF统计从imageData.json读取：**
```javascript
if (selectedImage.statistics) {
  kpiData.value = {
    totalArea: selectedImage.statistics.totalArea,
    plotCount: selectedImage.statistics.plotCount,
    matchRate: selectedImage.statistics.matchRate || '0',
    diffCount: selectedImage.statistics.diffCount || '0'
  }
}
```

3. **KMZ加载流程完善：**
- 监听source的change事件
- 等待state变为'ready'
- 自动计算面积和统计信息
- 添加超时机制（10秒）

---

#### 7. 界面布局优化
**修复日期：** 2025-10-22

**修复内容：**
1. 按钮垂直下移，水平位置保持右侧
2. "上传文件"按钮仅在识别结果选项卡显示
3. 优化识别结果列表各列宽度
4. 添加完整的元数据表单到上传对话框

**CSS调整：**
```scss
.card-header-with-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  
  .action-buttons {
    display: flex;
    gap: 10px;
    margin-top: 4px;  // 增加垂直间距
  }
}
```

---

#### 8. SHP文件删除不完整问题
**修复日期：** 2025-10-22

**问题描述：**
删除SHP文件时，只删除了.shp文件，其他相关文件（.dbf, .shx等）没有删除

**解决方案：**
```javascript
// 删除所有相关的SHP文件
const relatedExtensions = [
  '.shp', '.dbf', '.shx', '.prj', '.cpg', 
  '.sbn', '.sbx', '.shp.xml', '.qpj'
]

relatedExtensions.forEach(ext => {
  const relatedFile = path.join(dirPath, basename + ext)
  if (fs.existsSync(relatedFile)) {
    fs.unlinkSync(relatedFile)
    deletedFiles.push(basename + ext)
  }
})

// 同时删除元数据JSON文件和转换的GeoJSON文件
```

现在改为删除整个SHP文件夹：
```javascript
if (type === 'shp') {
  const basename = path.basename(filename, '.shp')
  const folderPath = path.join(SHP_DIR, basename)
  
  if (fs.existsSync(folderPath) && fs.statSync(folderPath).isDirectory()) {
    fs.rmSync(folderPath, { recursive: true, force: true })
  }
}
```

---

## 2025-10-21 更新汇总

### 功能实现

#### 1. 监测主控台功能升级
**实现日期：** 2025-10-21

**功能描述：**
- 优化识别结果筛选功能
- 改进地图图层管理
- 增强统计信息显示

---

#### 2. 识别结果功能增强
**实现日期：** 2025-10-21

**功能描述：**
- 支持多格式识别结果（SHP、GeoJSON、KMZ）
- 添加识别结果元数据编辑功能
- 改进识别结果列表显示

---

### 问题修复

#### 1. 监测主控台问题修复
**修复日期：** 2025-10-21

**修复内容：**
- 修复筛选条件不生效的问题
- 修复地图缩放异常
- 修复统计数据计算错误

---

## TIF统计信息生成指南

### 背景说明

**问题：** TIF影像文件本身只包含像元值，不包含统计信息，导致前端显示"暂无统计数据"

**解决方案：** 使用Python脚本预先生成统计信息，保存到 `imageData.json`

### Python脚本使用方法

#### 1. 安装依赖

```bash
# Windows用户（从 https://www.lfd.uci.edu/~gohlke/pythonlibs/#gdal 下载wheel）
pip install <下载的whl文件>

# Linux/Mac用户
pip install gdal numpy
```

#### 2. 运行脚本

```bash
python generate_tif_statistics.py <TIF文件路径>

# 示例
python generate_tif_statistics.py public/data/2024_kle_vh_kndvi.tif
```

#### 3. 脚本输出

脚本会分析TIF文件并生成如下统计信息：
- 总面积（亩）
- 像元数量
- 作物类型分布（百分比）

#### 4. 将statistics添加到imageData.json

将脚本生成的 `statistics` 对象复制到对应影像的配置中。

### 作物类型映射

| 像元值 | 作物类型 | 颜色代码 |
|--------|----------|----------|
| 0 | NoData | - |
| 1 | 裸地 | #D2B48C |
| 2 | 棉花 | #FFFFFF |
| 3 | 小麦 | #FFD700 |
| 4 | 玉米 | #FFA500 |
| 5 | 番茄 | #FF6347 |
| 6 | 甜菜 | #FF1493 |
| 7 | 打瓜 | #00FF7F |
| 8 | 辣椒 | #DC143C |
| 9 | 籽用葫芦 | #9370DB |
| 10 | 其它耕地 | #808080 |

---

## 技术要点总结

### 1. 文件格式支持
- **SHP**：打包成ZIP上传，自动解压和管理
- **GeoJSON**：直接上传
- **KMZ**：直接上传，自动解析
- **TIF**：需要预先生成统计信息

### 2. 坐标系处理
- EPSG:4326 - WGS84地理坐标系（经纬度）
- EPSG:3857 - Web Mercator投影坐标系（米制）
- 正确设置 `dataProjection` 和 `featureProjection`

### 3. 时间格式
- **存储**：ISO 8601 UTC格式
- **显示**：本地时区格式
- **转换**：东八区 = UTC + 8小时

### 4. 面积计算
- TIF：基于像元分辨率和数量
- SHP/GeoJSON：基于几何图形真实面积
- 单位转换：1亩 ≈ 666.67平方米

### 5. 元数据管理
- 影像数据：统一JSON文件
- 识别结果：独立JSON文件
- 时间字段优先级：createdAt > uploadTime > updatedAt > mtime

---

## 后续优化建议

### 高优先级
1. **后端API自动生成TIF统计信息**
   - 开发后端API调用Python脚本
   - 支持批量处理
   - 添加进度条显示

2. **识别任务元数据自动保存**
   - 任务完成时自动调用 `saveRecognitionMetadata`
   - 记录任务提交时间和完成时间

### 中优先级
1. **统计数据聚合**
   - 多文件总计统计
   - 对比分析功能
   - 导出统计报表

2. **图层控制面板**
   - 显示/隐藏单个图层
   - 调整图层顺序和透明度

### 低优先级
1. 文件切换动画效果
2. 移动端适配优化
3. 统计图表增强

---

## 测试清单

### SHP上传测试
- [x] 上传ZIP文件并自动解压
- [x] 元数据自动生成
- [x] 双层嵌套问题已修复
- [x] 下载时自动打包成ZIP
- [x] 删除时删除整个文件夹

### KMZ加载测试
- [x] 单个KMZ文件加载
- [x] 多个KMZ文件加载
- [x] 统计信息正确显示
- [x] 文件切换功能
- [x] 地图自动缩放

### 元数据测试
- [x] 上传时自动生成元数据
- [x] 编辑时保留创建时间
- [x] 时间字段正确显示
- [x] 时区转换正确

### 饼图测试
- [x] 显示所有作物类型
- [x] 颜色独特且明显
- [x] 图例与饼图对应

---

## 总结

截至 2025-10-22，系统已实现：

1. ✅ 完整的SHP文件夹上传、存储、下载、删除功能
2. ✅ 智能元数据管理系统（自动生成、保留时间戳）
3. ✅ 多文件KMZ加载和切换功能
4. ✅ 准确的统计信息计算和显示
5. ✅ 正确的坐标投影处理
6. ✅ 完整的作物类型饼图显示
7. ✅ 子文件夹SHP文件支持
8. ✅ 界面布局优化

所有核心功能已完成并测试通过！🎉

---

**最后更新：** 2025-10-22
**维护者：** AI Assistant

